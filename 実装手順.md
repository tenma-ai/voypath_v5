# Voypath 実装手順書 - Claude Code詳細ガイド

## 🚨 **実装開始前の絶対必須確認事項**

### ⚠️ **WARNING: 以下の手順を完了せずに実装を開始することは厳禁です**

**全ての実装作業開始前に、必ず以下のファイルを読んでから作業を開始してください：**
実装は全て英語で行うこと
1. **@実装手順.md** (このファイル) - 全体の実装手順とルール
2. **@進捗整理.md** - 現在の進捗状況と既知の問題
3. **@projectrules.md** - プロジェクトルールと品質基準

**必須動作：**
- 上記3ファイルを読了後、以下の発言を必ずユーザーに報告してください：
  - "実装手順.md、進捗整理.md、projectrules.mdを確認しました。現在のフェーズは[X]で、次に実装すべき項目は[Y]です。"

---

## 🔧 **開発環境・技術制約**

### 📋 **技術スタック確認**
- **フロントエンド**: React 18 + TypeScript + Tailwind CSS (変更禁止)
- **バックエンド**: Supabase PostgreSQL + Edge Functions
- **認証**: Supabase Auth (JWT)
- **決済**: Stripe
- **リアルタイム**: Supabase Realtime
- **デプロイ**: Vercel (フロントエンド) + Supabase (バックエンド)

### 🚫 **絶対禁止事項**
1. **UI/UXの変更** - userの許可がない限りフロントエンドコンポーネントは一切触らない
2. **ローカルストレージの使用** - 大規模拡大を視野に入れているためlocalStorage, sessionStorageは使用禁止
3. **既存テーブル構造の変更** - userの許可がない限りsupabase.sqlのテーブル構造は変更しない
4. **3回以上の同一エラー** - 同じエラーで3回失敗したら即停止

---

## 📊 **統合フルスタック実装ロードマップ**

### **🎯 フロントエンド↔バックエンド↔データベース完全統合方針**

**実装順序**: データベース → Edge Functions → フロントエンド統合 → リアルタイム同期 → 統合最適化

#### **統合実装フロー図**
```
Google Maps API → フロントエンド → Supabase API → データベース → Edge Functions最適化 → リアルタイム配信 → フロントエンド表示
```

@phase1and2.mdを確認
### **Phase 1: 統合データベース基盤構築** (TODO: 1-50)
#### **1.1 Supabaseプロジェクト設定 + 統合準備** (TODO: 1-15)
- **統合要素**: 完全サーバーサイド設計、リアルタイム準備、Edge Functions基盤
#### **1.2 統合認証システム構築** (TODO: 16-25)  
- **統合要素**: JWT統合、ゲスト→永続化フロー、デモユーザー管理
#### **1.3 基本CRUD操作 + リアルタイム統合** (TODO: 26-35)
- **統合要素**: 即座UI反映、サーバーサイド検証、データ整合性
#### **1.4 RLS (Row Level Security) + 統合セキュリティ** (TODO: 36-50)
- **統合要素**: 完全データ隔離、統合権限管理、セキュアAPI設計

@phase1and2.mdを確認
### **Phase 2: 統合APIエンドポイント開発** (TODO: 51-120)
#### **2.1 Trip管理API + 統合フロー** (TODO: 51-70)
- **統合要素**: フロントエンド即座反映、Edge Functions連携、出発地固定システム
#### **2.2 Place管理API + Google Places統合** (TODO: 71-90)
- **統合要素**: Google Places検索統合、リアルタイム追加、色システム準備
#### **2.3 Message/Chat API + リアルタイム統合** (TODO: 91-110)
- **統合要素**: Supabase Realtime活用、即座メッセージ配信、状態同期
#### **2.4 最適化アルゴリズムAPI + 統合計算** (TODO: 111-120)
- **統合要素**: Edge Functions最適化、リアルタイム結果配信、UI自動更新

@phase3and4.mdを確認
### **Phase 3: Stripe決済統合 + 統合課金** (TODO: 121-160)
#### **3.1 Stripe設定 + 統合決済フロー** (TODO: 121-135)
- **統合要素**: フロントエンド↔Stripe↔Supabase連携、状態即座反映
#### **3.2 サブスクリプション管理 + 統合状態管理** (TODO: 136-150)
- **統合要素**: リアルタイム課金状態同期、機能制限即座適用
#### **3.3 Webhook処理 + 統合イベント管理** (TODO: 151-160)
- **統合要素**: Stripe→Supabase→フロントエンド自動状態更新

@phase3and4.mdを確認
### **Phase 4: リアルタイム機能 + 統合同期** (TODO: 161-200)
#### **4.1 Supabase Realtime設定 + 統合チャンネル** (TODO: 161-175)
- **統合要素**: 全データタイプのリアルタイム化、フロントエンド自動更新
#### **4.2 チャット機能 + 統合コミュニケーション** (TODO: 176-190)
- **統合要素**: メッセージ即座配信、状態同期、通知統合
#### **4.3 最適化結果配信 + 統合表示** (TODO: 191-200)
- **統合要素**: 計算完了即座配信、UI自動更新、エラー状態同期

@phase5and6.mdを確認
### **Phase 5: 統合最適化アルゴリズム** (TODO: 201-250)
#### **5.1 基本最適化ロジック + 統合計算** (TODO: 201-220)
- **統合要素**: Edge Functions活用、リアルタイム進捗表示、結果即座配信
#### **5.2 公平性計算 + 統合メンバー管理** (TODO: 221-235)
- **統合要素**: メンバー色統合、リアルタイム公平性表示、動的再計算
#### **5.3 効率性計算 + 統合地理データ** (TODO: 236-250)
- **統合要素**: 地理的制約統合、リアルな移動時間、制約違反検知

@phase5and6.mdを確認
### **Phase 6: セキュリティ強化 + 統合保護** (TODO: 251-280)
#### **6.1 認証強化 + 統合セキュリティ** (TODO: 251-265)
- **統合要素**: 全レイヤーセキュリティ、統合監査ログ、侵入検知
#### **6.2 データ暗号化 + 統合保護** (TODO: 266-275)
- **統合要素**: エンドツーエンド保護、統合暗号化管理、キー統合
#### **6.3 セキュリティテスト + 統合監査** (TODO: 276-280)
- **統合要素**: 全スタック脆弱性テスト、統合セキュリティ監視

## ⚠️ **各TODO実装時の必須手順**

### **🔄 TODO実装の標準フロー**

#### **ステップ1: 実装開始前の確認** (必須)
1. **@実装手順.md** を再確認
2. **@進捗整理.md** で現在の状況確認
3. **@projectrules.md** でルール再確認
4. **発言必須**: "TODO-XXXの実装を開始します。前提確認完了。"

#### **ステップ2: 統合実装作業** (注意深く)
1. **UI/UXファイルには絶対に触らない** - フロントエンドは表示確認のみ
2. **完全サーバーサイド実装** - データ管理はSupabaseのみ
3. **ローカルストレージ使用禁止** - 全てリアルタイム同期で解決
4. **Supabase MCP最大活用** - データベース、Edge Functions、Realtime連携
5. **統合エラー3回で即停止** - フロントエンド↔バックエンド連携失敗時の緊急停止
6. **リアルタイム同期必須確認** - 各実装でリアルタイム反映テスト実行

#### **ステップ3: 統合テスト実行** (必須)
1. **基本機能テスト** - サーバーサイド機能の単体テスト
2. **統合フローテスト** - フロントエンド↔バックエンド↔データベース連携確認
3. **リアルタイム同期テスト** - Supabase Realtime による即座データ反映確認
4. **UI/UX影響確認** - 既存フロントエンド機能への影響がないことを確認（表示確認のみ）
5. **エラーハンドリングテスト** - 統合エラー時の適切な処理確認
6. **発言必須**: "TODO-XXXの統合テストが完了しました。結果: [成功/失敗]、統合状況: [詳細]"

#### **ステップ4: 統合GitHubプッシュ** (必須)
1. **統合変更内容をGitHubにプッシュ** - データベース、Edge Functions、設定ファイル
2. **統合コミットメッセージ**: "feat: TODO-XXX [統合実装内容] - integrate [Frontend↔Backend↔Database]"
3. **統合影響説明**: 変更が及ぼすシステム全体への影響を簡潔に記載
4. **発言必須**: "TODO-XXXの統合実装をGitHubにプッシュしました。統合範囲: [データベース/Edge Functions/API/Realtime]"

#### **ステップ5: 進捗更新** (必須)
1. **@実装手順.md** のTODOチェックボックスを更新
2. **@進捗整理.md** に実装結果を記録
3. **発言必須**: "TODO-XXXの進捗を更新しました。次のステップ準備完了。"

#### **ステップ6: 次ステップ準備** (必須)
1. **次のTODOの準備確認**
2. **依存関係の確認**
3. **必要に応じてユーザーアクションを要求**
4. **発言必須**: "TODO-XXX完了。次はTODO-YYYに進みます。"
5.発言さえすればユーザーアクションが必要ない場合はユーザーの許可を得ずとも自動で次のtodoに取り掛かって大丈夫です。

---

## 🚨 **統合緊急停止条件**

### **即座停止が必要な統合障害状況**
1. **同一統合エラーが3回発生** - フロントエンド↔バックエンド連携障害
2. **UI/UXファイルに予期しない変更** - フロントエンドファイル破損
3. **データベーステーブル構造の破損** - 統合データ整合性違反
4. **認証システムの障害** - Supabase Auth統合失敗
5. **Supabase接続の完全失敗** - バックエンドインフラ障害
6. **リアルタイム同期の完全停止** - Supabase Realtime障害
7. **Edge Functions実行エラー** - サーバーレス機能障害
8. **統合データ不整合検知** - フロントエンド↔データベース不一致

### **統合停止時の対応**
1. **全ての統合作業を即座停止** - フロントエンド・バックエンド・データベース操作停止
2. **統合エラー状況を詳細報告** - 障害レイヤー特定と影響範囲明示
3. **統合状態の安全復旧** - 前の安定統合状態への復旧実行
4. **統合問題解決まで実装停止** - 全レイヤー整合性確保まで作業禁止
5. **統合影響範囲の完全検証** - フロントエンド表示・バックエンド処理・データ整合性の全確認

---

## 📋 **統合最終確認事項**

この統合実装手順書に従って開発を進めることで：

✅ **統合安全性**: フロントエンド↔バックエンド↔データベースの完全統合を維持しつつ開発進行
✅ **統合品質**: 各段階での統合テストにより全レイヤー品質保証
✅ **統合追跡性**: フロントエンド・バックエンド・データベースの進捗を一元管理
✅ **統合効率性**: 統合エラー循環を防ぎ、リアルタイム同期による効率的開発
✅ **統合完全性**: 全400個のTODOで完全統合された旅行最適化プラットフォーム完成

**重要**: この統合手順書は400個以上のTODOを含む包括的なフルスタック統合実装ガイドです。各TODOは統合単位に分割されており、段階的な統合実装により確実に統合プロジェクトを完成に導きます。

### **🎯 統合実装の最終目標**

完成時に達成される**完全統合システム**：
- **Google Maps API → フロントエンド → Supabase API → データベース → Edge Functions最適化 → リアルタイム配信 → フロントエンド表示**の完全な循環
- **ゼロローカルストレージ**：全データのサーバーサイド管理とリアルタイム同期
- **完全リアルタイム**：全操作の即座反映とユーザー間同期
- **統合最適化**：地理的制約、メンバーカラーシステム、Google Places統合を含む包括的最適化

**開始前に必ず@実装手順.md、@進捗整理.md、@projectrules.mdを読んでから統合実装を開始してください。**

---


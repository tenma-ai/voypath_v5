# Voypath 要件定義書

## 1. プロジェクト概要

### 1.1 プロジェクト名
Voypath - 統合協調的旅行計画最適化アプリケーション（フルスタック統合版）

### 1.2 プロジェクトの目的
複数ユーザーが協力して旅行計画を立て、公平性と効率性を両立させた最適なルート提案を受けられる**完全統合型**Webアプリケーションの開発。

**統合システム特徴**：
- **Google Maps API → フロントエンド → Supabase API → データベース → Edge Functions最適化 → リアルタイム配信 → フロントエンド表示**の完全な統合フロー
- **ゼロローカルストレージ**：全データのサーバーサイド管理とリアルタイム同期
- **完全リアルタイム**：全操作の即座反映とマルチユーザー同期

### 1.3 対象ユーザー
- **プライマリーユーザー**: 友人・家族グループでの旅行を計画する人々
- **セカンダリーユーザー**: ビジネス出張での効率的な移動を求める人々
- **年齢層**: 20-50代
- **技術習熟度**: 一般的なWebアプリケーション利用経験

### 1.4 ビジネスゴール
1. **ユーザー満足度の向上**: 旅行計画の効率化と公平性の実現
2. **収益化**: プレミアム機能によるサブスクリプション収益
3. **ユーザーエンゲージメント**: 継続的な利用促進
4. **スケーラビリティ**: 大規模拡大への対応

## 2. 機能要件

### 2.1 コア機能

#### 2.1.1 ユーザー管理機能
**機能ID**: F001  
**優先度**: 高  
**説明**: ユーザーアカウントの作成・管理

**詳細要件**:
- ゲストユーザーとしての利用開始（名前のみで開始可能）
- メールアドレスでのアカウント登録
- ログイン・ログアウト機能
- プロフィール管理（名前、アバター、テーマ設定、言語設定）
- 通知設定の管理

**受け入れ条件**:
- ゲストユーザーでも基本機能が利用可能
- ユーザーデータは全てサーバーサイドで管理
- セッション管理によるシームレスなユーザー体験

#### 2.1.2 旅行作成・管理機能
**機能ID**: F002  
**優先度**: 高  
**説明**: 新しい旅行計画の作成と管理

**詳細要件**:
- 旅行基本情報の設定（名前、出発地、期間、説明）
- 旅行メンバーの招待・管理
- 場所追加締切の設定
- 旅行のアーカイブ・削除
- 旅行ごとの設定管理

**受け入れ条件**:
- 無料ユーザー: 最大3つの旅行
- プレミアムユーザー: 制限なし
- 旅行データのリアルタイム同期

#### 2.1.3 場所管理機能
**機能ID**: F003  
**優先度**: 高  
**説明**: 旅行先での訪問場所の追加・管理

**詳細要件**:
- 場所検索機能（模擬データベース）
- 場所の詳細情報設定（滞在時間、希望度、予算レベル、メモ）
- 訪問希望日の指定
- 場所のカテゴリ分類
- 場所の編集・削除

**受け入れ条件**:
- 無料ユーザー: 旅行ごとに最大10箇所
- プレミアムユーザー: 制限なし
- 場所データの即座反映

#### 2.1.4 ルート最適化機能
**機能ID**: F004  
**優先度**: 高  
**説明**: AI駆動による最適な訪問順序の提案

**詳細要件**:
- 複数ユーザーの希望を統合した公平性の考慮
- 移動効率を最大化するルート計算
- 営業時間制約の考慮
- 詳細スケジュールの自動生成
- 最適化結果のリアルタイム共有

**受け入れ条件**:
- 最適化完了まで30秒以内
- 公平性スコア・効率性スコアの表示
- 全メンバーへの即座な結果反映

#### 2.1.5 リアルタイムチャット機能
**機能ID**: F005  
**優先度**: 中  
**説明**: 旅行メンバー間のコミュニケーション

**詳細要件**:
- テキストメッセージの送受信
- 場所共有メッセージ
- システム通知メッセージ
- メッセージ履歴の保存

**受け入れ条件**:
- メッセージのリアルタイム配信
- オフライン時のメッセージ受信
- 既読・未読状態の管理

### 2.2 プレミアム機能

#### 2.2.1 サブスクリプション管理
**機能ID**: F006  
**優先度**: 高  
**説明**: Stripe連携による決済・サブスクリプション管理

**詳細要件**:
- 月額・年額プランの選択
- Stripe Checkoutによる決済処理
- サブスクリプション状態の管理
- 請求履歴の確認
- プラン変更・キャンセル機能

**受け入れ条件**:
- セキュアな決済処理
- 決済状態の即座反映
- PCI DSS準拠

#### 2.2.2 高度な最適化機能
**機能ID**: F007  
**優先度**: 中  
**説明**: プレミアムユーザー向け高度な最適化

**詳細要件**:
- より精密な最適化アルゴリズム
- 交通手段の選択オプション
- 天候・イベント情報の考慮
- カスタム制約の設定

**受け入れ条件**:
- プレミアムユーザーのみアクセス可能
- 高度な計算処理の安定実行

### 2.3 外部連携機能

#### 2.3.1 地図・位置情報連携
**機能ID**: F008  
**優先度**: 中  
**説明**: 地図表示と位置情報の活用

**詳細要件**:
- インタラクティブマップでの場所表示
- 最適化ルートの可視化
- 現在位置の取得（オプション）

**受け入れ条件**:
- 地図の滑らかな操作性
- ルート表示の明確性

## 3. 非機能要件

### 3.1 パフォーマンス要件

#### 3.1.1 レスポンス時間
- **画面遷移**: 1秒以内
- **データ取得**: 2秒以内
- **ルート最適化**: 30秒以内
- **リアルタイム更新**: 1秒以内

#### 3.1.2 スループット
- **同時接続ユーザー**: 1,000人以上
- **同時処理可能な最適化**: 100件以上

### 3.2 可用性要件
- **アップタイム**: 99.9%以上
- **メンテナンス時間**: 月間4時間以内
- **障害復旧時間**: 1時間以内

### 3.3 スケーラビリティ要件
- **ユーザー数**: 100万人まで対応
- **旅行数**: 1,000万件まで対応
- **場所数**: 1億件まで対応

### 3.4 セキュリティ要件

#### 3.4.1 認証・認可
- JWT（JSON Web Token）による認証
- Row Level Security（RLS）による認可
- セッション管理の安全性

#### 3.4.2 データ保護
- 全通信のHTTPS化
- 個人情報の暗号化
- GDPR・CCPA準拠

#### 3.4.3 API セキュリティ
- Rate Limiting
- SQL Injection対策
- XSS対策

### 3.5 ユーザビリティ要件
- **モバイルフレンドリー**: 全機能がモバイルで利用可能
- **アクセシビリティ**: WCAG 2.1 AA準拠
- **多言語対応**: 英語・日本語対応

### 3.6 互換性要件

#### 3.6.1 ブラウザ対応
- Chrome（最新2バージョン）
- Firefox（最新2バージョン）
- Safari（最新2バージョン）
- Edge（最新2バージョン）

#### 3.6.2 デバイス対応
- デスクトップ（1280px以上）
- タブレット（768px-1279px）
- スマートフォン（767px以下）

## 4. 技術要件

### 4.1 統合フロントエンド技術スタック
- **フレームワーク**: React 18+ with TypeScript
- **ビルドツール**: Vite
- **状態管理**: Zustand（**完全サーバーサイド同期**）
- **UI ライブラリ**: Tailwind CSS
- **アニメーション**: Framer Motion
- **アイコン**: Lucide React
- **デプロイ**: Vercel
- **統合制約**: **ローカルストレージ使用禁止**、全データサーバーサイド管理

### 4.2 統合バックエンド技術スタック
- **Database**: Supabase (PostgreSQL) + **統合リアルタイム同期**
- **認証**: Supabase Auth + **統合セッション管理**
- **API**: Supabase Auto-generated REST API + **統合Edge Functions**
- **リアルタイム**: Supabase Realtime（**全テーブル対応**）
- **ファイルストレージ**: Supabase Storage
- **決済**: Stripe + **統合Webhook処理**
- **サーバーレス関数**: Supabase Edge Functions (Deno) + **統合最適化処理**
- **外部API統合**: Google Places API + **統合キャッシュシステム**

### 4.3 統合アーキテクチャ仕様
- **完全統合フロー**: `Google API → Frontend → Supabase → Database → Edge Functions → Realtime → Frontend`
- **ゼロローカルストレージ**: 全データのサーバーサイド管理
- **リアルタイム同期**: 全操作の即座反映
- **統合エラーハンドリング**: 全レイヤーでの一貫したエラー処理
- **統合セキュリティ**: RLS + JWT + 暗号化の多層防御

### 4.3 開発・運用環境
- **バージョン管理**: Git
- **CI/CD**: Vercel + Supabase CLI
- **監視**: Supabase Dashboard + Vercel Analytics
- **ログ管理**: Supabase Logs
- **エラー追跡**: 統合エラー追跡

## 5. 制約事項

### 5.1 統合技術的制約
- **完全統合データ管理**: ローカルストレージ一切使用禁止、全データSupabaseサーバーサイド管理
- **統合ブラウザ制限**: localStorage、sessionStorage使用禁止、全てリアルタイム同期で解決
- **統合オフライン制約**: 初期バージョンでは対応しない（リアルタイム統合優先）
- **統合外部API管理**: Google Places API + 統合キャッシュシステムによる最適化
- **統合フロントエンド制約**: UI/UXファイル変更禁止、表示確認のみ許可
- **統合リアルタイム必須**: 全操作でSupabase Realtime同期必須

### 5.2 ビジネス制約
- **予算制限**: 初期開発予算内での実装
- **開発期間**: 6ヶ月以内でのMVPリリース
- **法的制約**: GDPR、CCPA等のデータ保護法への準拠

### 5.3 運用制約
- **メンテナンス**: 平日深夜帯（1:00-5:00 JST）での実施
- **データバックアップ**: 日次自動バックアップ
- **障害対応**: 24時間以内の初期対応

## 6. 成功指標（KPI）

### 6.1 ユーザー指標
- **新規ユーザー登録数**: 月間1,000人以上
- **アクティブユーザー率**: 月間60%以上
- **ユーザー継続率**: 3ヶ月後50%以上

### 6.2 機能利用指標
- **旅行作成率**: 登録ユーザーの80%以上
- **最適化実行率**: 作成旅行の70%以上
- **メンバー招待率**: 旅行の60%以上で実行

### 6.3 ビジネス指標
- **プレミアム転換率**: 5%以上
- **解約率**: 月間3%以下
- **顧客生涯価値（LTV）**: $50以上

### 6.4 技術指標
- **システム稼働率**: 99.9%以上
- **平均レスポンス時間**: 1秒以内
- **エラー率**: 0.1%以下

## 7. リスク管理

### 7.1 技術リスク
| リスク | 影響度 | 発生確率 | 対策 |
|--------|--------|----------|------|
| Supabase障害 | 高 | 低 | 冗長化、代替サービス調査 |
| パフォーマンス劣化 | 中 | 中 | 継続的監視、最適化 |
| セキュリティ脆弱性 | 高 | 低 | 定期的監査、アップデート |

### 7.2 ビジネスリスク
| リスク | 影響度 | 発生確率 | 対策 |
|--------|--------|----------|------|
| 競合他社参入 | 中 | 高 | 差別化機能強化 |
| 法規制変更 | 中 | 低 | 法務チェック体制 |
| 市場需要低下 | 高 | 低 | 市場調査、ピボット準備 |

## 8. 開発フェーズ

### 8.1 フェーズ1: MVPリリース（3ヶ月）
- ユーザー管理機能
- 基本的な旅行・場所管理
- シンプルな最適化アルゴリズム
- プレミアム機能の基盤

### 8.2 フェーズ2: 機能拡張（2ヶ月）
- リアルタイムチャット
- 高度な最適化機能
- モバイル最適化
- パフォーマンス改善

### 8.3 フェーズ3: スケール対応（1ヶ月）
- 大量ユーザー対応
- 国際化対応
- 高度な分析機能
- API公開準備

## 9. 品質保証

### 9.1 テスト要件
- **単体テスト**: カバレッジ80%以上
- **統合テスト**: 主要フロー100%
- **E2Eテスト**: クリティカルパス100%
- **パフォーマンステスト**: 負荷テスト実施

### 9.2 コード品質
- **TypeScript**: 厳密な型チェック
- **ESLint**: コード品質チェック
- **Prettier**: コードフォーマット統一
- **コードレビュー**: 全変更の必須レビュー

### 9.3 セキュリティテスト
- **脆弱性スキャン**: 定期実行
- **ペネトレーションテスト**: リリース前実施
- **依存関係監査**: 自動化されたチェック

## 10. 保守・運用要件

### 10.1 監視要件
- **アプリケーション監視**: リアルタイム性能監視
- **データベース監視**: クエリパフォーマンス監視
- **エラー監視**: 自動アラート設定
- **ユーザー行動分析**: 利用パターン分析

### 10.2 バックアップ・復旧
- **データバックアップ**: 日次自動バックアップ
- **災害復旧**: RTO 2時間、RPO 1時間
- **データ保持**: 7年間の保持ポリシー

### 10.3 更新・メンテナンス
- **セキュリティパッチ**: 即座適用
- **機能更新**: 2週間サイクル
- **メジャーアップデート**: 四半期ごと
- **メンテナンス通知**: 事前24時間通知

---

## 11. 追加機能要件 - メンバーカラーシステム

### 11.1 メンバーカラー管理機能
**機能ID**: F009  
**優先度**: 中  
**説明**: 旅行メンバーごとの個別カラー割り当てとルート表示での活用

**詳細要件**:
- 20色のリファインドカラーパレットから自動割り当て
- 旅行内でのメンバーカラー重複防止
- メンバー参加時の自動カラー割り当て
- カラー表示の一貫性確保
- カラーデータのリアルタイム同期

**受け入れ条件**:
- 同一旅行内で色重複の完全回避
- メンバー追加/削除時の即座色再計算
- 全デバイスでの色表示一貫性
- 色覚障害者への配慮（高コントラスト）

### 11.2 場所カラー計算機能
**機能ID**: F010  
**優先度**: 中  
**説明**: 場所の貢献者数に基づく動的カラー表示

**詳細要件**:
- 単一貢献者: メンバーカラー表示
- 2-3貢献者: グラデーションカラー表示
- 4+貢献者: 特別ゴールドカラー表示
- 出発地・目的地: 固定ゴールドカラー
- 貢献者変更時の自動色更新

**受け入れ条件**:
- カラー計算の高速実行（100ms以内）
- リアルタイムカラー更新
- 視覚的に美しいグラデーション表示
- 貢献者情報の正確な反映

### 11.3 ルート表示カラー統合
**機能ID**: F011  
**優先度**: 中  
**説明**: 最適化ルート表示でのメンバーカラー活用

**詳細要件**:
- ルート上の場所にカラー情報表示
- メンバー別の場所識別支援
- カラー付きスケジュール表示
- カラーレジェンド表示
- カラーフィルタリング機能

**受け入れ条件**:
- ルート表示の視認性向上
- メンバー貢献度の明確な可視化
- カラー情報の保存・復元
- 印刷時のカラー表示対応

---

## 12. 追加機能要件 - 地理的制約・リアルな経路計算

### 12.1 地理的制約システム
**機能ID**: F012  
**優先度**: 高  
**説明**: 現実的な地理的制約を考慮した経路計算

**詳細要件**:
- 水路横断制約（フェリー時間考慮）
- 陸路制約（国境、道路状況）
- 航空路制約（空港手続き時間）
- 通行禁止区域の除外
- 季節・時間による制約変動

**受け入れ条件**:
- 制約チェックの高速実行
- 現実的な移動時間計算
- 制約違反時の明確なエラー表示
- 代替ルート提案機能

### 12.2 交通手段制約管理
**機能ID**: F013  
**優先度**: 中  
**説明**: 旅行ごとの交通手段制約設定

**詳細要件**:
- 最大徒歩距離設定
- 最大運転時間制限
- 許可交通手段選択
- アクセシビリティ対応
- 予算制約による交通手段制限

**受け入れ条件**:
- 制約設定の柔軟性
- 制約違反の事前検知
- 制約に基づく最適化実行
- 制約変更の即座反映

### 12.3 リアル移動時間計算
**機能ID**: F014  
**優先度**: 中  
**説明**: より正確な移動時間・コスト計算

**詳細要件**:
- 交通手段別の詳細計算
- 待ち時間・乗り換え時間考慮
- 移動コスト自動計算
- 信頼度スコア表示
- 時間帯による変動考慮

**受け入れ条件**:
- 計算精度の向上（誤差±20%以内）
- 計算速度の維持（5秒以内）
- コスト情報の正確性
- 信頼度情報の有用性

---

## 13. 追加機能要件 - Google Places API統合

### 13.1 Places検索機能
**機能ID**: F015  
**優先度**: 高  
**説明**: Google Places APIを活用した高精度場所検索

**詳細要件**:
- テキスト検索による場所検索
- 位置ベース周辺検索
- カテゴリ別フィルタリング
- 詳細情報自動取得
- 検索履歴管理

**受け入れ条件**:
- 検索結果の高精度
- 検索速度の高速化（2秒以内）
- APIコストの最適化
- 検索結果の豊富な情報

### 13.2 Places データキャッシュ
**機能ID**: F016  
**優先度**: 中  
**説明**: Places API結果の効率的キャッシュ管理

**詳細要件**:
- 検索結果の7日間キャッシュ
- キャッシュヒット率最適化
- 期限切れデータ自動削除
- キャッシュ無効化機能
- キャッシュ統計監視

**受け入れ条件**:
- キャッシュヒット率80%以上
- API使用量50%削減
- キャッシュデータの整合性
- ストレージ使用量最適化

### 13.3 Places自動インポート
**機能ID**: F017  
**優先度**: 中  
**説明**: Google Places → 内部Place自動変換

**詳細要件**:
- Places情報の正規化
- 重複場所の自動検知
- データ品質検証
- インポート履歴管理
- エラーハンドリング

**受け入れ条件**:
- データ変換の正確性
- 重複検知率95%以上
- インポート速度の高速化
- データ整合性の保証

---

## 14. 拡張システム要件

### 14.1 追加パフォーマンス要件

#### 14.1.1 メンバーカラーシステム
- **カラー計算時間**: 100ms以内
- **カラー同期時間**: 500ms以内
- **カラーデータキャッシュ**: 99%ヒット率

#### 14.1.2 地理的制約システム
- **制約チェック時間**: 200ms以内
- **制約データ取得**: 1秒以内
- **制約計算スループット**: 1000件/秒

#### 14.1.3 Google Places統合
- **Places検索時間**: 2秒以内
- **キャッシュヒット率**: 80%以上
- **API使用量削減**: 50%以上

### 14.2 追加セキュリティ要件

#### 14.2.1 Places データ保護
- Google Places APIキーの安全管理
- Places検索履歴の暗号化
- APIレート制限の適切な実装

#### 14.2.2 地理データ保護
- 位置情報の適切な匿名化
- 地理的制約データの完全性保証
- 制約計算結果の検証

### 14.3 追加監視要件

#### 14.3.1 新機能監視
- カラーシステムパフォーマンス監視
- 地理的制約計算精度監視
- Places API使用量・コスト監視
- 新機能エラー率監視

#### 14.3.2 統合システム監視
- 全機能間の依存関係監視
- データ整合性監視
- ユーザーエクスペリエンス影響監視

---

## 15. 拡張成功指標（KPI）

### 15.1 新機能利用指標
- **カラーシステム利用率**: 旅行の90%以上でカラー機能活用
- **制約設定利用率**: 旅行の30%以上で地理的制約設定
- **Places検索利用率**: 場所追加の70%以上でPlaces検索利用

### 15.2 システム品質指標
- **カラー計算精度**: 99.9%以上
- **制約計算精度**: 95%以上
- **Places検索満足度**: 4.5/5.0以上

### 15.3 コスト効率指標
- **Google Places APIコスト**: 月間予算内で運用
- **キャッシュ効率**: APIコスト50%削減達成
- **計算リソース効率**: 新機能追加後もレスポンス時間維持

---

## 16. フルスタック統合要件

### 16.1 統合データフロー要件
**機能ID**: F018  
**優先度**: 最高  
**説明**: フロントエンド↔バックエンド↔データベース完全統合

**詳細要件**:
- Google Maps API検索からリアルタイム表示までの完全統合フロー
- Supabase Realtime による即座データ同期
- Edge Functions による最適化処理統合
- 全レイヤーでの統合エラーハンドリング
- ゼロローカルストレージによる完全サーバーサイド管理

**受け入れ条件**:
- 全操作でのリアルタイム反映（1秒以内）
- データ不整合ゼロ
- フロントエンド↔バックエンド完全同期
- 統合エラー処理による障害回復

### 16.2 統合リアルタイム同期要件
**機能ID**: F019  
**優先度**: 最高  
**説明**: 全テーブル・全操作のリアルタイム同期

**詳細要件**:
- 全CRUD操作の即座反映
- マルチユーザー間の完全同期
- 最適化結果のリアルタイム配信
- メンバーカラー変更の即座反映
- 統合エラー状態の即座同期

**受け入れ条件**:
- 同期遅延1秒以内
- 同期成功率99.9%以上
- 統合同期エラーの自動回復
- 全ユーザーでの一貫した状態表示

### 16.3 統合最適化システム要件
**機能ID**: F020  
**優先度**: 高  
**説明**: Edge Functions + データベース + リアルタイム統合最適化

**詳細要件**:
- Edge Functions での高速最適化計算
- 地理的制約統合チェック
- メンバーカラーシステム統合
- Google Places データ統合活用
- 最適化結果のリアルタイム配信

**受け入れ条件**:
- 統合最適化時間30秒以内
- 制約違反時の即座フィードバック
- 最適化結果の全ユーザー即座反映
- 統合データ整合性の完全保証

---

## 17. 統合成功指標（KPI）

### 17.1 統合システム指標
- **統合応答時間**: フロントエンド→バックエンド→フロントエンド 1秒以内
- **統合同期率**: リアルタイム同期成功率 99.9%以上
- **統合データ整合性**: データ不整合発生率 0.01%以下
- **統合エラー回復**: システム障害からの自動回復率 95%以上

### 17.2 統合ユーザー体験指標
- **統合操作満足度**: リアルタイム反映による満足度 4.8/5.0以上
- **統合機能利用率**: 全統合機能の利用率 85%以上
- **統合エラー影響**: 統合エラーによるユーザー体験阻害 1%以下

### 17.3 統合技術指標
- **統合API効率**: Google Places API統合使用量最適化 50%削減
- **統合計算性能**: Edge Functions統合処理時間 80%短縮
- **統合監視精度**: 統合システム監視による問題検知率 98%以上

**重要**: これらの統合機能により、Voypathは単なる旅行計画アプリから、**完全統合された高度な地理的知識とユーザー体験最適化を統合した包括的な旅行プラットフォーム**へと進化します。各新機能は既存システムと**完全に統合**され、ユーザーの旅行計画体験を**革新的に向上**させます。

**統合アーキテクチャ完成により実現される価値**:
- **ゼロローカルストレージ**: 全データのサーバーサイド統合管理
- **完全リアルタイム**: 全操作の即座反映とマルチユーザー同期  
- **統合最適化**: 地理的制約、メンバーカラー、Google Places の包括的統合
- **統合セキュリティ**: 全レイヤーでの一貫したセキュリティ保護
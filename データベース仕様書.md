# Voypath データベース仕様書

## 1. 概要
実装は全て英語で行うこと
### 1.1 データベース構成
- **Database Engine**: PostgreSQL 15+ (Supabase)
- **接続方法**: Supabase Client Library
- **認証**: Supabase Auth + JWT
- **セキュリティ**: Row Level Security (RLS)
- **リアルタイム**: Supabase Realtime
- **バックアップ**: Supabase自動バックアップ + Point-in-Time Recovery

### 1.2 設計原則
1. **ゼロローカルストレージ**: 全データをサーバーサイドで管理
2. **厳密なRLS**: ユーザーは自身のデータのみアクセス可能
3. **リアルタイム同期**: 変更の即座反映
4. **スケーラビリティ**: 大量データ・ユーザーに対応
5. **ACID準拠**: データ整合性の保証

## 2. スキーマ設計

### 2.1 Extension設定
```sql
-- UUID生成用
CREATE EXTENSION IF NOT EXISTS "uuid-ossp";

-- 全文検索用
CREATE EXTENSION IF NOT EXISTS "pg_trgm";

-- 地理空間データ用（将来拡張）
CREATE EXTENSION IF NOT EXISTS "postgis";

-- 暗号化関数用
CREATE EXTENSION IF NOT EXISTS "pgcrypto";
```

### 2.2 カスタム型定義
```sql
-- 曜日列挙型
CREATE TYPE day_of_week AS ENUM (
  'sunday', 'monday', 'tuesday', 'wednesday', 
  'thursday', 'friday', 'saturday'
);

-- 交通手段列挙型
CREATE TYPE transport_mode AS ENUM (
  'walking', 'public_transport', 'car', 'bicycle', 'taxi'
);

-- メッセージタイプ列挙型
CREATE TYPE message_type AS ENUM (
  'text', 'place_suggestion', 'route_update', 'system_notification'
);

-- 場所色タイプ列挙型 (New)
CREATE TYPE place_color_type AS ENUM (
  'single', 'gradient', 'gold', 'departure', 'unassigned'
);

-- 地理的制約タイプ列挙型 (New)
CREATE TYPE geographic_constraint_type AS ENUM (
  'land_crossing', 'water_crossing', 'air_route', 'blocked'
);

-- 旅行メンバー役割列挙型
CREATE TYPE member_role AS ENUM ('admin', 'member');

-- 通知タイプ列挙型
CREATE TYPE notification_type AS ENUM (
  'trip_invitation', 'place_added', 'optimization_completed', 
  'message_received', 'deadline_reminder'
);
```

## 3. テーブル設計

### 3.1 users テーブル
```sql
CREATE TABLE users (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  email TEXT UNIQUE,
  name TEXT NOT NULL,
  display_name TEXT,
  avatar_url TEXT,
  is_guest BOOLEAN DEFAULT true,
  is_premium BOOLEAN DEFAULT false,
  premium_expires_at TIMESTAMPTZ,
  theme_preference TEXT DEFAULT 'light' CHECK (theme_preference IN ('light', 'dark', 'system')),
  language_preference TEXT DEFAULT 'en' CHECK (language_preference IN ('en', 'ja', 'ko', 'zh')),
  notification_settings JSONB DEFAULT '{
    "members": true,
    "updates": true, 
    "messages": true,
    "reminders": true
  }'::jsonb,
  timezone TEXT DEFAULT 'UTC',
  last_login_at TIMESTAMPTZ,
  last_active_at TIMESTAMPTZ DEFAULT NOW(),
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW(),
  
  -- Stripe連携
  stripe_customer_id TEXT UNIQUE,
  stripe_subscription_id TEXT UNIQUE,
  
  -- メタデータ
  metadata JSONB DEFAULT '{}'::jsonb,
  
  -- 制約
  CONSTRAINT valid_email CHECK (email ~* '^[A-Za-z0-9._%+-]+@[A-Za-z0-9.-]+\.[A-Z|a-z]{2,}$' OR email IS NULL),
  CONSTRAINT valid_name_length CHECK (char_length(name) >= 1 AND char_length(name) <= 100),
  CONSTRAINT valid_premium_expiry CHECK (
    (is_premium = false AND premium_expires_at IS NULL) OR
    (is_premium = true AND premium_expires_at IS NOT NULL)
  )
);

-- インデックス
CREATE INDEX idx_users_email ON users(email) WHERE email IS NOT NULL;
CREATE INDEX idx_users_is_premium ON users(is_premium);
CREATE INDEX idx_users_premium_expires_at ON users(premium_expires_at) WHERE premium_expires_at IS NOT NULL;
CREATE INDEX idx_users_stripe_customer_id ON users(stripe_customer_id) WHERE stripe_customer_id IS NOT NULL;
CREATE INDEX idx_users_stripe_subscription_id ON users(stripe_subscription_id) WHERE stripe_subscription_id IS NOT NULL;
CREATE INDEX idx_users_created_at ON users(created_at);
CREATE INDEX idx_users_last_active_at ON users(last_active_at);

-- 全文検索インデックス
CREATE INDEX idx_users_name_trgm ON users USING gin(name gin_trgm_ops);
```

### 3.2 trips テーブル
```sql
CREATE TABLE trips (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  name TEXT,
  description TEXT,
  departure_location TEXT NOT NULL,
  destination TEXT,
  start_date DATE,
  end_date DATE,
  owner_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE ON UPDATE CASCADE,
  
  -- 設定
  add_place_deadline TIMESTAMPTZ,
  max_members INTEGER DEFAULT 10,
  is_public BOOLEAN DEFAULT false,
  
  -- メタデータ
  icon TEXT, -- 画像URL
  tags TEXT[], -- 旅行タグ
  budget_range JSONB, -- {"min": 10000, "max": 50000, "currency": "JPY"}
  
  -- 最適化設定
  optimization_preferences JSONB DEFAULT '{
    "fairness_weight": 0.6,
    "efficiency_weight": 0.4,
    "auto_optimize": false,
    "include_meals": true,
    "preferred_transport": null
  }'::jsonb,
  
  -- 統計情報
  total_places INTEGER DEFAULT 0,
  total_members INTEGER DEFAULT 1,
  last_optimized_at TIMESTAMPTZ,
  
  -- タイムスタンプ
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW(),
  
  -- 制約
  CONSTRAINT valid_date_range CHECK (end_date IS NULL OR start_date IS NULL OR end_date >= start_date),
  CONSTRAINT valid_name_length CHECK (name IS NULL OR (char_length(name) >= 1 AND char_length(name) <= 200)),
  CONSTRAINT valid_departure_location_length CHECK (char_length(departure_location) >= 1 AND char_length(departure_location) <= 200),
  CONSTRAINT valid_destination_length CHECK (destination IS NULL OR (char_length(destination) >= 1 AND char_length(destination) <= 200)),
  CONSTRAINT valid_max_members CHECK (max_members >= 1 AND max_members <= 50),
  CONSTRAINT valid_deadline CHECK (add_place_deadline IS NULL OR add_place_deadline <= start_date)
);

-- インデックス
CREATE INDEX idx_trips_owner_id ON trips(owner_id);
CREATE INDEX idx_trips_start_date ON trips(start_date);
CREATE INDEX idx_trips_end_date ON trips(end_date);
CREATE INDEX idx_trips_departure_location ON trips(departure_location);
CREATE INDEX idx_trips_destination ON trips(destination) WHERE destination IS NOT NULL;
CREATE INDEX idx_trips_created_at ON trips(created_at);
CREATE INDEX idx_trips_is_public ON trips(is_public) WHERE is_public = true;

-- 全文検索インデックス
CREATE INDEX idx_trips_name_trgm ON trips USING gin(name gin_trgm_ops);
CREATE INDEX idx_trips_description_trgm ON trips USING gin(description gin_trgm_ops) WHERE description IS NOT NULL;
```

### 3.3 places テーブル
```sql
CREATE TABLE places (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  name TEXT NOT NULL,
  category TEXT NOT NULL,
  address TEXT,
  
  -- 地理情報
  latitude DECIMAL(10, 8),
  longitude DECIMAL(11, 8),
  location_point GEOGRAPHY(POINT, 4326), -- PostGIS地点データ
  
  -- 評価・希望度
  rating DECIMAL(2,1) CHECK (rating >= 0 AND rating <= 5),
  wish_level INTEGER NOT NULL CHECK (wish_level >= 1 AND wish_level <= 5),
  
  -- 滞在・予算情報
  stay_duration_minutes INTEGER NOT NULL CHECK (stay_duration_minutes > 0),
  price_level INTEGER CHECK (price_level >= 1 AND price_level <= 4),
  estimated_cost INTEGER CHECK (estimated_cost >= 0),
  
  -- 営業時間（JSONB形式）
  opening_hours JSONB DEFAULT '{}'::jsonb,
  
  -- メディア
  image_url TEXT,
  images TEXT[], -- 複数画像URL
  
  -- スケジュール情報
  scheduled BOOLEAN DEFAULT false,
  scheduled_date DATE,
  scheduled_time_start TIME,
  scheduled_time_end TIME,
  visit_date DATE, -- ユーザー希望日
  preferred_time_slots TEXT[], -- ['morning', 'afternoon', 'evening']
  
  -- 交通情報
  transport_mode transport_mode,
  travel_time_from_previous INTEGER, -- 前の場所からの移動時間（分）
  
  -- メタデータ
  notes TEXT,
  tags TEXT[],
  external_id TEXT, -- 外部API（Google Places等）のID
  source TEXT DEFAULT 'user', -- 'user', 'google_places', 'foursquare'
  
  -- リレーション
  trip_id UUID NOT NULL REFERENCES trips(id) ON DELETE CASCADE ON UPDATE CASCADE,
  user_id UUID NOT NULL REFERENCES users(id) ON DELETE SET NULL ON UPDATE CASCADE,
  
  -- 最適化関連
  normalized_weight DECIMAL(10, 6), -- 正規化された重み
  optimization_metadata JSONB DEFAULT '{}'::jsonb,
  
  -- タイムスタンプ
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW(),
  
  -- 制約
  CONSTRAINT valid_coordinates CHECK (
    (latitude IS NULL AND longitude IS NULL) OR
    (latitude IS NOT NULL AND longitude IS NOT NULL AND
     latitude >= -90 AND latitude <= 90 AND
     longitude >= -180 AND longitude <= 180)
  ),
  CONSTRAINT valid_name_length CHECK (char_length(name) >= 1 AND char_length(name) <= 200),
  CONSTRAINT valid_visit_date_in_trip CHECK (
    visit_date IS NULL OR 
    (visit_date >= (SELECT start_date FROM trips WHERE trips.id = trip_id) AND
     visit_date <= (SELECT end_date FROM trips WHERE trips.id = trip_id))
  )
);

-- インデックス
CREATE INDEX idx_places_trip_id ON places(trip_id);
CREATE INDEX idx_places_user_id ON places(user_id);
CREATE INDEX idx_places_category ON places(category);
CREATE INDEX idx_places_scheduled ON places(scheduled);
CREATE INDEX idx_places_visit_date ON places(visit_date);
CREATE INDEX idx_places_wish_level ON places(wish_level);
CREATE INDEX idx_places_created_at ON places(created_at);

-- 複合インデックス
CREATE INDEX idx_places_trip_scheduled ON places(trip_id, scheduled);
CREATE INDEX idx_places_trip_category ON places(trip_id, category);
CREATE INDEX idx_places_trip_user ON places(trip_id, user_id);

-- 地理空間インデックス
CREATE INDEX idx_places_location_point ON places USING GIST(location_point) WHERE location_point IS NOT NULL;

-- 全文検索インデックス
CREATE INDEX idx_places_name_trgm ON places USING gin(name gin_trgm_ops);
CREATE INDEX idx_places_address_trgm ON places USING gin(address gin_trgm_ops) WHERE address IS NOT NULL;
```

### 3.4 trip_members テーブル
```sql
CREATE TABLE trip_members (
  trip_id UUID NOT NULL REFERENCES trips(id) ON DELETE CASCADE ON UPDATE CASCADE,
  user_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE ON UPDATE CASCADE,
  role member_role DEFAULT 'member',
  
  -- 参加情報
  joined_at TIMESTAMPTZ DEFAULT NOW(),
  invited_by UUID REFERENCES users(id) ON DELETE SET NULL,
  invitation_accepted_at TIMESTAMPTZ,
  
  -- 権限設定
  can_add_places BOOLEAN DEFAULT true,
  can_edit_places BOOLEAN DEFAULT false, -- 他のユーザーの場所を編集可能か
  can_optimize BOOLEAN DEFAULT true,
  can_invite_members BOOLEAN DEFAULT false,
  
  -- メタデータ
  nickname TEXT, -- 旅行内でのニックネーム
  preferences JSONB DEFAULT '{}'::jsonb,
  
  PRIMARY KEY (trip_id, user_id),
  
  -- 制約
  CONSTRAINT valid_nickname_length CHECK (nickname IS NULL OR char_length(nickname) <= 50)
);

-- インデックス
CREATE INDEX idx_trip_members_trip_id ON trip_members(trip_id);
CREATE INDEX idx_trip_members_user_id ON trip_members(user_id);
CREATE INDEX idx_trip_members_role ON trip_members(role);
CREATE INDEX idx_trip_members_joined_at ON trip_members(joined_at);
```

### 3.5 messages テーブル
```sql
CREATE TABLE messages (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  trip_id UUID NOT NULL REFERENCES trips(id) ON DELETE CASCADE ON UPDATE CASCADE,
  user_id UUID REFERENCES users(id) ON DELETE SET NULL ON UPDATE CASCADE,
  
  -- メッセージ内容
  content TEXT NOT NULL,
  message_type message_type DEFAULT 'text',
  
  -- 添付データ
  attachments JSONB DEFAULT '[]'::jsonb, -- ファイル、画像等
  mentioned_users UUID[], -- メンション対象ユーザー
  
  -- 返信情報
  reply_to UUID REFERENCES messages(id) ON DELETE SET NULL,
  thread_id UUID, -- スレッドID
  
  -- メタデータ
  metadata JSONB DEFAULT '{}'::jsonb, -- place_share時の場所情報等
  edited_at TIMESTAMPTZ,
  is_deleted BOOLEAN DEFAULT false,
  
  -- タイムスタンプ
  created_at TIMESTAMPTZ DEFAULT NOW(),
  
  -- 制約
  CONSTRAINT valid_content_length CHECK (char_length(content) >= 1 AND char_length(content) <= 4000),
  CONSTRAINT valid_system_message CHECK (
    (message_type = 'system' AND user_id IS NULL) OR
    (message_type != 'system' AND user_id IS NOT NULL)
  )
);

-- インデックス
CREATE INDEX idx_messages_trip_id ON messages(trip_id);
CREATE INDEX idx_messages_user_id ON messages(user_id);
CREATE INDEX idx_messages_created_at ON messages(created_at);
CREATE INDEX idx_messages_message_type ON messages(message_type);
CREATE INDEX idx_messages_reply_to ON messages(reply_to) WHERE reply_to IS NOT NULL;
CREATE INDEX idx_messages_thread_id ON messages(thread_id) WHERE thread_id IS NOT NULL;

-- 複合インデックス
CREATE INDEX idx_messages_trip_created ON messages(trip_id, created_at DESC);

-- 全文検索インデックス
CREATE INDEX idx_messages_content_trgm ON messages USING gin(content gin_trgm_ops) WHERE is_deleted = false;
```

### 3.6 optimization_results テーブル（統合強化版）
```sql
CREATE TABLE optimization_results (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  trip_id UUID NOT NULL REFERENCES trips(id) ON DELETE CASCADE ON UPDATE CASCADE,
  created_by UUID REFERENCES users(id) ON DELETE SET NULL ON UPDATE CASCADE,
  
  -- 最適化結果（フロントエンド→バックエンド→フロントエンド統合対応）
  optimized_route JSONB NOT NULL, -- 日別スケジュール + カラー情報
  optimization_score JSONB NOT NULL, -- スコア詳細
  route_coordinates JSONB, -- 地理座標データ（地図表示用）
  travel_segments JSONB, -- 移動区間詳細（リアルタイム表示用）
  member_color_assignments JSONB, -- メンバーカラー情報
  
  -- 実行情報
  execution_time_ms INTEGER NOT NULL,
  places_count INTEGER NOT NULL,
  algorithm_version TEXT DEFAULT '2.0', -- 統合アルゴリズム版
  processing_steps JSONB, -- 最適化過程の詳細ログ
  
  -- 設定
  optimization_settings JSONB DEFAULT '{}'::jsonb,
  ui_display_settings JSONB DEFAULT '{}'::jsonb, -- フロントエンド表示設定
  
  -- 統計情報
  total_travel_time_minutes INTEGER,
  total_visit_time_minutes INTEGER,
  total_estimated_cost INTEGER,
  geographical_coverage_km2 DECIMAL(10,2), -- 地理的カバレッジ
  
  -- リアルタイム統合情報
  realtime_broadcast_at TIMESTAMPTZ, -- リアルタイム配信時刻
  frontend_acknowledgments JSONB DEFAULT '[]'::jsonb, -- フロントエンド受信確認
  display_mode_compatibility JSONB DEFAULT '{
    "map_view": true,
    "timeline_view": true, 
    "calendar_view": true
  }'::jsonb,
  
  -- メタデータ
  is_active BOOLEAN DEFAULT true, -- 現在適用中の最適化結果か
  superseded_by UUID REFERENCES optimization_results(id), -- 後継結果ID
  notes TEXT,
  
  -- タイムスタンプ
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW(),
  
  -- 制約
  CONSTRAINT valid_execution_time CHECK (execution_time_ms > 0),
  CONSTRAINT valid_places_count CHECK (places_count > 0),
  CONSTRAINT valid_travel_time CHECK (total_travel_time_minutes IS NULL OR total_travel_time_minutes >= 0),
  CONSTRAINT valid_visit_time CHECK (total_visit_time_minutes IS NULL OR total_visit_time_minutes >= 0),
  CONSTRAINT valid_geographical_coverage CHECK (geographical_coverage_km2 IS NULL OR geographical_coverage_km2 >= 0)
);

-- インデックス（統合強化版）
CREATE INDEX idx_optimization_results_trip_id ON optimization_results(trip_id);
CREATE INDEX idx_optimization_results_created_by ON optimization_results(created_by);
CREATE INDEX idx_optimization_results_created_at ON optimization_results(created_at);
CREATE INDEX idx_optimization_results_is_active ON optimization_results(is_active) WHERE is_active = true;
CREATE INDEX idx_optimization_results_realtime_broadcast ON optimization_results(realtime_broadcast_at);

-- 複合インデックス
CREATE INDEX idx_optimization_results_trip_active ON optimization_results(trip_id, is_active) WHERE is_active = true;
CREATE INDEX idx_optimization_results_trip_realtime ON optimization_results(trip_id, realtime_broadcast_at DESC);

-- 統合システム用JSONB GINインデックス
CREATE INDEX idx_optimization_results_route_gin ON optimization_results USING gin(optimized_route);
CREATE INDEX idx_optimization_results_coordinates_gin ON optimization_results USING gin(route_coordinates);
CREATE INDEX idx_optimization_results_segments_gin ON optimization_results USING gin(travel_segments);
CREATE INDEX idx_optimization_results_member_colors_gin ON optimization_results USING gin(member_color_assignments);
```

### 3.7 notifications テーブル
```sql
CREATE TABLE notifications (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE ON UPDATE CASCADE,
  
  -- 通知内容
  title TEXT NOT NULL,
  content TEXT NOT NULL,
  notification_type notification_type NOT NULL,
  
  -- 関連データ
  trip_id UUID REFERENCES trips(id) ON DELETE CASCADE,
  related_user_id UUID REFERENCES users(id) ON DELETE SET NULL,
  related_place_id UUID REFERENCES places(id) ON DELETE SET NULL,
  related_message_id UUID REFERENCES messages(id) ON DELETE SET NULL,
  
  -- 状態
  is_read BOOLEAN DEFAULT false,
  read_at TIMESTAMPTZ,
  
  -- アクション
  action_url TEXT,
  action_data JSONB DEFAULT '{}'::jsonb,
  
  -- タイムスタンプ
  created_at TIMESTAMPTZ DEFAULT NOW(),
  expires_at TIMESTAMPTZ,
  
  -- 制約
  CONSTRAINT valid_title_length CHECK (char_length(title) >= 1 AND char_length(title) <= 200),
  CONSTRAINT valid_content_length CHECK (char_length(content) >= 1 AND char_length(content) <= 1000),
  CONSTRAINT valid_expiry CHECK (expires_at IS NULL OR expires_at > created_at)
);

-- インデックス
CREATE INDEX idx_notifications_user_id ON notifications(user_id);
CREATE INDEX idx_notifications_trip_id ON notifications(trip_id) WHERE trip_id IS NOT NULL;
CREATE INDEX idx_notifications_is_read ON notifications(is_read);
CREATE INDEX idx_notifications_created_at ON notifications(created_at);
CREATE INDEX idx_notifications_expires_at ON notifications(expires_at) WHERE expires_at IS NOT NULL;

-- 複合インデックス
CREATE INDEX idx_notifications_user_unread ON notifications(user_id, is_read) WHERE is_read = false;
```

### 3.8 invitation_codes テーブル
```sql
CREATE TABLE invitation_codes (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  trip_id UUID NOT NULL REFERENCES trips(id) ON DELETE CASCADE ON UPDATE CASCADE,
  created_by UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE ON UPDATE CASCADE,
  
  -- 招待コード
  code TEXT NOT NULL UNIQUE,
  
  -- 設定
  max_uses INTEGER DEFAULT 1,
  current_uses INTEGER DEFAULT 0,
  expires_at TIMESTAMPTZ,
  
  -- 状態
  is_active BOOLEAN DEFAULT true,
  
  -- メタデータ
  description TEXT,
  
  -- タイムスタンプ
  created_at TIMESTAMPTZ DEFAULT NOW(),
  used_at TIMESTAMPTZ[],
  
  -- 制約
  CONSTRAINT valid_code_format CHECK (code ~ '^[A-Z0-9]{6,12}$'),
  CONSTRAINT valid_max_uses CHECK (max_uses > 0),
  CONSTRAINT valid_current_uses CHECK (current_uses >= 0 AND current_uses <= max_uses),
  CONSTRAINT valid_expiry CHECK (expires_at IS NULL OR expires_at > created_at)
);

-- インデックス
CREATE UNIQUE INDEX idx_invitation_codes_code ON invitation_codes(code);
CREATE INDEX idx_invitation_codes_trip_id ON invitation_codes(trip_id);
CREATE INDEX idx_invitation_codes_created_by ON invitation_codes(created_by);
CREATE INDEX idx_invitation_codes_is_active ON invitation_codes(is_active) WHERE is_active = true;
CREATE INDEX idx_invitation_codes_expires_at ON invitation_codes(expires_at) WHERE expires_at IS NOT NULL;
```

### 3.9 usage_events テーブル（分析用）
```sql
CREATE TABLE usage_events (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID REFERENCES users(id) ON DELETE SET NULL ON UPDATE CASCADE,
  
  -- イベント情報
  event_type TEXT NOT NULL,
  event_category TEXT, -- 'optimization', 'trip_management', 'social' など
  
  -- 関連データ
  trip_id UUID REFERENCES trips(id) ON DELETE SET NULL,
  session_id TEXT,
  
  -- メタデータ
  metadata JSONB DEFAULT '{}'::jsonb,
  
  -- 技術情報
  user_agent TEXT,
  ip_address INET,
  
  -- タイムスタンプ
  created_at TIMESTAMPTZ DEFAULT NOW(),
  
  -- 制約
  CONSTRAINT valid_event_type_length CHECK (char_length(event_type) >= 1 AND char_length(event_type) <= 100)
);

-- パーティション設定（月別）
CREATE INDEX idx_usage_events_created_at ON usage_events(created_at);
CREATE INDEX idx_usage_events_user_id ON usage_events(user_id);
CREATE INDEX idx_usage_events_event_type ON usage_events(event_type);
CREATE INDEX idx_usage_events_trip_id ON usage_events(trip_id) WHERE trip_id IS NOT NULL;

-- 複合インデックス
CREATE INDEX idx_usage_events_user_created ON usage_events(user_id, created_at) WHERE user_id IS NOT NULL;
```

### 3.10 optimization_cache テーブル
```sql
CREATE TABLE optimization_cache (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  trip_id UUID NOT NULL REFERENCES trips(id) ON DELETE CASCADE ON UPDATE CASCADE,
  
  -- キャッシュキー
  places_hash TEXT NOT NULL,
  settings_hash TEXT NOT NULL,
  
  -- キャッシュデータ
  result JSONB NOT NULL,
  metadata JSONB DEFAULT '{}'::jsonb,
  
  -- 統計情報
  hit_count INTEGER DEFAULT 0,
  last_accessed_at TIMESTAMPTZ DEFAULT NOW(),
  
  -- タイムスタンプ
  created_at TIMESTAMPTZ DEFAULT NOW(),
  expires_at TIMESTAMPTZ NOT NULL,
  
  -- 制約
  CONSTRAINT valid_hash_format CHECK (
    places_hash ~ '^[A-Za-z0-9+/=]{20,}$' AND
    settings_hash ~ '^[A-Za-z0-9+/=]{10,}$'
  ),
  CONSTRAINT valid_expiry CHECK (expires_at > created_at),
  CONSTRAINT valid_hit_count CHECK (hit_count >= 0)
);

-- インデックス
CREATE INDEX idx_optimization_cache_trip_id ON optimization_cache(trip_id);
CREATE INDEX idx_optimization_cache_expires_at ON optimization_cache(expires_at);
CREATE INDEX idx_optimization_cache_last_accessed ON optimization_cache(last_accessed_at);

-- 複合インデックス（キャッシュ検索用）
CREATE UNIQUE INDEX idx_optimization_cache_lookup ON optimization_cache(trip_id, places_hash, settings_hash);
```

## 4. Row Level Security (RLS) ポリシー

### 4.1 RLS有効化
```sql
-- 全テーブルでRLS有効化
ALTER TABLE users ENABLE ROW LEVEL SECURITY;
ALTER TABLE trips ENABLE ROW LEVEL SECURITY;
ALTER TABLE places ENABLE ROW LEVEL SECURITY;
ALTER TABLE trip_members ENABLE ROW LEVEL SECURITY;
ALTER TABLE messages ENABLE ROW LEVEL SECURITY;
ALTER TABLE optimization_results ENABLE ROW LEVEL SECURITY;
ALTER TABLE notifications ENABLE ROW LEVEL SECURITY;
ALTER TABLE invitation_codes ENABLE ROW LEVEL SECURITY;
ALTER TABLE usage_events ENABLE ROW LEVEL SECURITY;
ALTER TABLE optimization_cache ENABLE ROW LEVEL SECURITY;
```

### 4.2 usersテーブルのRLSポリシー
```sql
-- ユーザーは自分の情報のみ参照可能
CREATE POLICY "Users can view own profile" ON users
  FOR SELECT
  USING (auth.uid() = id);

-- ユーザーは自分の情報のみ更新可能
CREATE POLICY "Users can update own profile" ON users
  FOR UPDATE
  USING (auth.uid() = id)
  WITH CHECK (auth.uid() = id);

-- 新規ユーザー登録（ゲストユーザー含む）
CREATE POLICY "Enable insert for authenticated users" ON users
  FOR INSERT
  WITH CHECK (auth.uid() = id);

-- 他のユーザーの基本情報は参照可能（旅行メンバー表示用）
CREATE POLICY "Users can view public info of trip members" ON users
  FOR SELECT
  USING (
    id IN (
      SELECT tm.user_id 
      FROM trip_members tm 
      WHERE tm.trip_id IN (
        SELECT tm2.trip_id 
        FROM trip_members tm2 
        WHERE tm2.user_id = auth.uid()
      )
    )
  );
```

### 4.3 tripsテーブルのRLSポリシー
```sql
-- 旅行メンバーのみ参照可能
CREATE POLICY "Trip members can view trips" ON trips
  FOR SELECT
  USING (
    id IN (
      SELECT trip_id 
      FROM trip_members 
      WHERE user_id = auth.uid()
    )
  );

-- 旅行作成者のみ更新可能
CREATE POLICY "Trip owners can update trips" ON trips
  FOR UPDATE
  USING (owner_id = auth.uid())
  WITH CHECK (owner_id = auth.uid());

-- 認証済みユーザーは新規旅行作成可能
CREATE POLICY "Authenticated users can create trips" ON trips
  FOR INSERT
  WITH CHECK (
    auth.uid() = owner_id AND
    auth.uid() IS NOT NULL
  );

-- 旅行作成者のみ削除可能
CREATE POLICY "Trip owners can delete trips" ON trips
  FOR DELETE
  USING (owner_id = auth.uid());
```

### 4.4 placesテーブルのRLSポリシー
```sql
-- 旅行メンバーは場所を参照可能
CREATE POLICY "Trip members can view places" ON places
  FOR SELECT
  USING (
    trip_id IN (
      SELECT trip_id 
      FROM trip_members 
      WHERE user_id = auth.uid()
    )
  );

-- 旅行メンバーは場所を追加可能
CREATE POLICY "Trip members can add places" ON places
  FOR INSERT
  WITH CHECK (
    auth.uid() = user_id AND
    trip_id IN (
      SELECT tm.trip_id 
      FROM trip_members tm 
      WHERE tm.user_id = auth.uid() AND tm.can_add_places = true
    )
  );

-- 場所追加者または管理者のみ更新可能
CREATE POLICY "Place owners or admins can update places" ON places
  FOR UPDATE
  USING (
    user_id = auth.uid() OR
    trip_id IN (
      SELECT tm.trip_id 
      FROM trip_members tm 
      WHERE tm.user_id = auth.uid() AND 
            (tm.role = 'admin' OR tm.can_edit_places = true)
    )
  )
  WITH CHECK (
    user_id = auth.uid() OR
    trip_id IN (
      SELECT tm.trip_id 
      FROM trip_members tm 
      WHERE tm.user_id = auth.uid() AND 
            (tm.role = 'admin' OR tm.can_edit_places = true)
    )
  );

-- 場所追加者または管理者のみ削除可能
CREATE POLICY "Place owners or admins can delete places" ON places
  FOR DELETE
  USING (
    user_id = auth.uid() OR
    trip_id IN (
      SELECT tm.trip_id 
      FROM trip_members tm 
      WHERE tm.user_id = auth.uid() AND tm.role = 'admin'
    )
  );
```

### 4.5 messagesテーブルのRLSポリシー
```sql
-- 旅行メンバーはメッセージを参照可能
CREATE POLICY "Trip members can view messages" ON messages
  FOR SELECT
  USING (
    trip_id IN (
      SELECT trip_id 
      FROM trip_members 
      WHERE user_id = auth.uid()
    )
  );

-- 旅行メンバーはメッセージを送信可能
CREATE POLICY "Trip members can send messages" ON messages
  FOR INSERT
  WITH CHECK (
    auth.uid() = user_id AND
    trip_id IN (
      SELECT trip_id 
      FROM trip_members 
      WHERE user_id = auth.uid()
    )
  );

-- メッセージ送信者のみ更新・削除可能
CREATE POLICY "Message authors can update messages" ON messages
  FOR UPDATE
  USING (user_id = auth.uid())
  WITH CHECK (user_id = auth.uid());

CREATE POLICY "Message authors can delete messages" ON messages
  FOR DELETE
  USING (user_id = auth.uid());
```

### 4.6 最適化関連テーブルのRLSポリシー
```sql
-- optimization_results
CREATE POLICY "Trip members can view optimization results" ON optimization_results
  FOR SELECT
  USING (
    trip_id IN (
      SELECT trip_id 
      FROM trip_members 
      WHERE user_id = auth.uid()
    )
  );

CREATE POLICY "Trip members can create optimization results" ON optimization_results
  FOR INSERT
  WITH CHECK (
    auth.uid() = created_by AND
    trip_id IN (
      SELECT tm.trip_id 
      FROM trip_members tm 
      WHERE tm.user_id = auth.uid() AND tm.can_optimize = true
    )
  );

-- optimization_cache
CREATE POLICY "Trip members can view optimization cache" ON optimization_cache
  FOR SELECT
  USING (
    trip_id IN (
      SELECT trip_id 
      FROM trip_members 
      WHERE user_id = auth.uid()
    )
  );

CREATE POLICY "Trip members can manage optimization cache" ON optimization_cache
  FOR ALL
  USING (
    trip_id IN (
      SELECT trip_id 
      FROM trip_members 
      WHERE user_id = auth.uid()
    )
  );
```

## 5. データベース関数

### 5.1 旅行作成時の自動処理
```sql
CREATE OR REPLACE FUNCTION create_trip_with_owner(
  p_departure_location TEXT,
  p_name TEXT DEFAULT NULL,
  p_description TEXT DEFAULT NULL,
  p_destination TEXT DEFAULT NULL,
  p_start_date DATE DEFAULT NULL,
  p_end_date DATE DEFAULT NULL,
  p_owner_id UUID
) RETURNS UUID AS $$
DECLARE
  v_trip_id UUID;
  v_final_destination TEXT;
BEGIN
  -- 旅行作成
  -- nameが未設定の場合、自動生成
  IF p_name IS NULL THEN
    p_name := p_departure_location || 'からの旅行';
  END IF;
  
  -- destination処理ロジック
  -- 空文字列または未設定、または"same as departure location"の場合は出発地をdestinationに設定
  IF p_destination IS NULL OR p_destination = '' OR LOWER(p_destination) = 'same as departure location' THEN
    v_final_destination := p_departure_location;
  ELSE
    v_final_destination := p_destination;
  END IF;
  
  INSERT INTO trips (departure_location, name, description, destination, start_date, end_date, owner_id)
  VALUES (p_departure_location, p_name, p_description, v_final_destination, p_start_date, p_end_date, p_owner_id)
  RETURNING id INTO v_trip_id;
  
  -- 作成者を管理者として自動追加
  INSERT INTO trip_members (trip_id, user_id, role, can_add_places, can_edit_places, can_optimize, can_invite_members)
  VALUES (v_trip_id, p_owner_id, 'admin', true, true, true, true);
  
  -- 出発地と目的地をplacesテーブルに自動追加
  -- 出発地を最初の場所として追加
  INSERT INTO places (
    name, 
    category, 
    trip_id, 
    user_id, 
    wish_level, 
    stay_duration_minutes,
    scheduled,
    scheduled_date,
    notes,
    source
  ) VALUES (
    p_departure_location || ' (Departure)',
    'departure_point',
    v_trip_id,
    p_owner_id,
    5,
    60,
    CASE WHEN p_start_date IS NOT NULL THEN true ELSE false END,
    p_start_date,
    'Auto-generated departure location',
    'system'
  );
  
  -- 目的地を最後の場所として追加（出発地と異なる場合のみ）
  IF v_final_destination != p_departure_location THEN
    INSERT INTO places (
      name, 
      category, 
      trip_id, 
      user_id, 
      wish_level, 
      stay_duration_minutes,
      scheduled,
      scheduled_date,
      notes,
      source
    ) VALUES (
      v_final_destination || ' (Final Destination)',
      'destination_point',
      v_trip_id,
      p_owner_id,
      5,
      60,
      CASE WHEN p_end_date IS NOT NULL THEN true ELSE false END,
      p_end_date,
      'Auto-generated final destination',
      'system'
    );
  ELSE
    -- 同じ場所の場合、出発地が最終目的地も兼ねる
    INSERT INTO places (
      name, 
      category, 
      trip_id, 
      user_id, 
      wish_level, 
      stay_duration_minutes,
      scheduled,
      scheduled_date,
      notes,
      source
    ) VALUES (
      v_final_destination || ' (Return)',
      'return_point',
      v_trip_id,
      p_owner_id,
      5,
      60,
      CASE WHEN p_end_date IS NOT NULL THEN true ELSE false END,
      p_end_date,
      'Auto-generated return to departure location',
      'system'
    );
  END IF;
  
  -- 統計更新
  UPDATE trips SET total_members = 1 WHERE id = v_trip_id;
  
  RETURN v_trip_id;
END;
$$ LANGUAGE plpgsql SECURITY DEFINER;
```

### 5.2 招待コード生成
```sql
CREATE OR REPLACE FUNCTION generate_invitation_code(
  p_trip_id UUID,
  p_created_by UUID,
  p_max_uses INTEGER DEFAULT 1,
  p_expires_hours INTEGER DEFAULT 72
) RETURNS TEXT AS $$
DECLARE
  v_code TEXT;
  v_exists BOOLEAN;
BEGIN
  -- 権限チェック
  IF NOT EXISTS (
    SELECT 1 FROM trip_members 
    WHERE trip_id = p_trip_id 
    AND user_id = p_created_by 
    AND (role = 'admin' OR can_invite_members = true)
  ) THEN
    RAISE EXCEPTION 'Insufficient permissions to create invitation code';
  END IF;
  
  -- ユニークなコード生成
  LOOP
    v_code := UPPER(
      SUBSTRING(
        ENCODE(gen_random_bytes(6), 'base64'),
        1, 8
      )
    );
    
    -- 英数字のみに変換
    v_code := REGEXP_REPLACE(v_code, '[^A-Z0-9]', '', 'g');
    
    -- 8文字に調整
    IF LENGTH(v_code) < 8 THEN
      v_code := v_code || SUBSTRING('ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789', 1, 8 - LENGTH(v_code));
    ELSE
      v_code := SUBSTRING(v_code, 1, 8);
    END IF;
    
    SELECT EXISTS(SELECT 1 FROM invitation_codes WHERE code = v_code) INTO v_exists;
    EXIT WHEN NOT v_exists;
  END LOOP;
  
  -- 招待コード保存
  INSERT INTO invitation_codes (trip_id, created_by, code, max_uses, expires_at)
  VALUES (
    p_trip_id, 
    p_created_by, 
    v_code, 
    p_max_uses,
    NOW() + INTERVAL '1 hour' * p_expires_hours
  );
  
  RETURN v_code;
END;
$$ LANGUAGE plpgsql SECURITY DEFINER;
```

### 5.3 招待コード使用
```sql
CREATE OR REPLACE FUNCTION use_invitation_code(
  p_code TEXT,
  p_user_id UUID
) RETURNS UUID AS $$
DECLARE
  v_invitation invitation_codes%ROWTYPE;
  v_trip_id UUID;
BEGIN
  -- 招待コード検証
  SELECT * INTO v_invitation 
  FROM invitation_codes 
  WHERE code = UPPER(p_code) 
  AND is_active = true 
  AND (expires_at IS NULL OR expires_at > NOW())
  AND current_uses < max_uses;
  
  IF NOT FOUND THEN
    RAISE EXCEPTION 'Invalid or expired invitation code';
  END IF;
  
  v_trip_id := v_invitation.trip_id;
  
  -- 既存メンバーチェック
  IF EXISTS (
    SELECT 1 FROM trip_members 
    WHERE trip_id = v_trip_id AND user_id = p_user_id
  ) THEN
    RAISE EXCEPTION 'User is already a member of this trip';
  END IF;
  
  -- メンバー追加
  INSERT INTO trip_members (trip_id, user_id, role, invited_by, invitation_accepted_at)
  VALUES (v_trip_id, p_user_id, 'member', v_invitation.created_by, NOW());
  
  -- 使用回数更新
  UPDATE invitation_codes 
  SET current_uses = current_uses + 1,
      used_at = array_append(used_at, NOW())
  WHERE id = v_invitation.id;
  
  -- 旅行の総メンバー数更新
  UPDATE trips 
  SET total_members = (
    SELECT COUNT(*) FROM trip_members WHERE trip_id = v_trip_id
  )
  WHERE id = v_trip_id;
  
  -- 通知作成
  INSERT INTO notifications (
    user_id, title, content, notification_type, trip_id, related_user_id
  )
  SELECT 
    tm.user_id,
    'New member joined',
    (SELECT name FROM users WHERE id = p_user_id) || ' joined ' || t.name,
    'trip_invitation',
    v_trip_id,
    p_user_id
  FROM trip_members tm
  JOIN trips t ON t.id = v_trip_id
  WHERE tm.trip_id = v_trip_id AND tm.user_id != p_user_id;
  
  RETURN v_trip_id;
END;
$$ LANGUAGE plpgsql SECURITY DEFINER;
```

### 5.4 統計情報更新
```sql
CREATE OR REPLACE FUNCTION update_trip_statistics(p_trip_id UUID) RETURNS VOID AS $$
BEGIN
  UPDATE trips SET
    total_places = (
      SELECT COUNT(*) FROM places WHERE trip_id = p_trip_id
    ),
    total_members = (
      SELECT COUNT(*) FROM trip_members WHERE trip_id = p_trip_id
    ),
    updated_at = NOW()
  WHERE id = p_trip_id;
END;
$$ LANGUAGE plpgsql SECURITY DEFINER;
```

### 5.5 期限切れデータクリーンアップ
```sql
CREATE OR REPLACE FUNCTION cleanup_expired_data() RETURNS INTEGER AS $$
DECLARE
  v_deleted_count INTEGER := 0;
BEGIN
  -- 期限切れ最適化キャッシュ削除
  DELETE FROM optimization_cache WHERE expires_at < NOW();
  GET DIAGNOSTICS v_deleted_count = ROW_COUNT;
  
  -- 期限切れ招待コード無効化
  UPDATE invitation_codes 
  SET is_active = false 
  WHERE expires_at < NOW() AND is_active = true;
  
  -- 期限切れ通知削除
  DELETE FROM notifications WHERE expires_at < NOW();
  
  -- 古い使用状況イベント削除（3ヶ月以上古い）
  DELETE FROM usage_events WHERE created_at < NOW() - INTERVAL '3 months';
  
  RETURN v_deleted_count;
END;
$$ LANGUAGE plpgsql SECURITY DEFINER;
```

## 6. トリガー

### 6.1 更新日時自動更新
```sql
CREATE OR REPLACE FUNCTION update_updated_at_column()
RETURNS TRIGGER AS $$
BEGIN
  NEW.updated_at = NOW();
  RETURN NEW;
END;
$$ LANGUAGE plpgsql;

-- 各テーブルにトリガー適用
CREATE TRIGGER update_users_updated_at 
  BEFORE UPDATE ON users 
  FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();

CREATE TRIGGER update_trips_updated_at 
  BEFORE UPDATE ON trips 
  FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();

CREATE TRIGGER update_places_updated_at 
  BEFORE UPDATE ON places 
  FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();
```

### 6.2 地理空間データ自動更新
```sql
CREATE OR REPLACE FUNCTION update_location_point()
RETURNS TRIGGER AS $$
BEGIN
  IF NEW.latitude IS NOT NULL AND NEW.longitude IS NOT NULL THEN
    NEW.location_point = ST_SetSRID(ST_MakePoint(NEW.longitude, NEW.latitude), 4326);
  ELSE
    NEW.location_point = NULL;
  END IF;
  RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER update_places_location_point
  BEFORE INSERT OR UPDATE ON places
  FOR EACH ROW EXECUTE FUNCTION update_location_point();
```

### 6.3 統計情報自動更新
```sql
CREATE OR REPLACE FUNCTION auto_update_trip_statistics()
RETURNS TRIGGER AS $$
BEGIN
  IF TG_OP = 'INSERT' THEN
    PERFORM update_trip_statistics(NEW.trip_id);
  ELSIF TG_OP = 'DELETE' THEN
    PERFORM update_trip_statistics(OLD.trip_id);
  ELSIF TG_OP = 'UPDATE' AND NEW.trip_id != OLD.trip_id THEN
    PERFORM update_trip_statistics(OLD.trip_id);
    PERFORM update_trip_statistics(NEW.trip_id);
  END IF;
  
  RETURN COALESCE(NEW, OLD);
END;
$$ LANGUAGE plpgsql;

-- 場所追加・削除時の統計更新
CREATE TRIGGER auto_update_places_statistics
  AFTER INSERT OR UPDATE OR DELETE ON places
  FOR EACH ROW EXECUTE FUNCTION auto_update_trip_statistics();

-- メンバー追加・削除時の統計更新
CREATE TRIGGER auto_update_members_statistics
  AFTER INSERT OR UPDATE OR DELETE ON trip_members
  FOR EACH ROW EXECUTE FUNCTION auto_update_trip_statistics();
```

### 6.4 通知自動生成
```sql
CREATE OR REPLACE FUNCTION create_notification_on_place_add()
RETURNS TRIGGER AS $$
BEGIN
  -- 新しい場所が追加された時、他のメンバーに通知
  INSERT INTO notifications (user_id, title, content, notification_type, trip_id, related_place_id, related_user_id)
  SELECT 
    tm.user_id,
    'New place added',
    (SELECT name FROM users WHERE id = NEW.user_id) || ' added ' || NEW.name || ' to ' || (SELECT name FROM trips WHERE id = NEW.trip_id),
    'place_added',
    NEW.trip_id,
    NEW.id,
    NEW.user_id
  FROM trip_members tm
  WHERE tm.trip_id = NEW.trip_id 
  AND tm.user_id != NEW.user_id;
  
  RETURN NEW;
END;
$$ LANGUAGE plpgsql SECURITY DEFINER;

CREATE TRIGGER notify_place_added
  AFTER INSERT ON places
  FOR EACH ROW EXECUTE FUNCTION create_notification_on_place_add();
```

## 7. ビュー

### 7.1 旅行サマリービュー
```sql
CREATE VIEW trip_summary AS
SELECT 
  t.id,
  t.name,
  t.description,
  t.departure_location,
  t.destination,
  t.start_date,
  t.end_date,
  t.created_at,
  t.updated_at,
  
  -- 統計情報
  COUNT(DISTINCT tm.user_id) as member_count,
  COUNT(DISTINCT p.id) as place_count,
  COUNT(DISTINCT p.id) FILTER (WHERE p.scheduled = true) as scheduled_place_count,
  
  -- 最新活動
  MAX(p.created_at) as last_place_added,
  MAX(m.created_at) as last_message_sent,
  MAX(or_recent.created_at) as last_optimized,
  
  -- 所有者情報
  u.name as owner_name,
  u.avatar_url as owner_avatar,
  
  -- 進捗情報
  CASE 
    WHEN t.start_date > CURRENT_DATE THEN 'planning'
    WHEN t.end_date < CURRENT_DATE THEN 'completed'
    ELSE 'active'
  END as status,
  
  -- 場所追加期限
  CASE 
    WHEN t.add_place_deadline IS NOT NULL AND t.add_place_deadline < NOW() THEN true
    ELSE false
  END as add_place_deadline_passed

FROM trips t
LEFT JOIN users u ON u.id = t.owner_id
LEFT JOIN trip_members tm ON tm.trip_id = t.id
LEFT JOIN places p ON p.trip_id = t.id
LEFT JOIN messages m ON m.trip_id = t.id
LEFT JOIN optimization_results or_recent ON or_recent.trip_id = t.id AND or_recent.is_active = true

GROUP BY t.id, u.name, u.avatar_url, or_recent.created_at;
```

### 7.2 ユーザー活動サマリービュー
```sql
CREATE VIEW user_activity_summary AS
SELECT 
  u.id,
  u.name,
  u.email,
  u.is_premium,
  u.last_active_at,
  
  -- 旅行統計
  COUNT(DISTINCT t.id) as total_trips,
  COUNT(DISTINCT CASE WHEN tm.role = 'admin' THEN t.id END) as owned_trips,
  COUNT(DISTINCT p.id) as total_places_added,
  COUNT(DISTINCT m.id) as total_messages_sent,
  
  -- 最適化統計
  COUNT(DISTINCT or_stats.id) as optimization_runs,
  AVG(or_stats.execution_time_ms) as avg_optimization_time,
  
  -- 最新活動
  MAX(p.created_at) as last_place_added,
  MAX(m.created_at) as last_message_sent,
  MAX(or_stats.created_at) as last_optimization_run

FROM users u
LEFT JOIN trip_members tm ON tm.user_id = u.id
LEFT JOIN trips t ON t.id = tm.trip_id
LEFT JOIN places p ON p.user_id = u.id
LEFT JOIN messages m ON m.user_id = u.id
LEFT JOIN optimization_results or_stats ON or_stats.created_by = u.id

GROUP BY u.id, u.name, u.email, u.is_premium, u.last_active_at;
```

## 8. インデックス最適化

### 8.1 複合インデックス戦略
```sql
-- 旅行検索用複合インデックス
CREATE INDEX idx_trips_search_optimized ON trips(owner_id, start_date DESC, created_at DESC);

-- 場所フィルタリング用複合インデックス
CREATE INDEX idx_places_trip_filters ON places(trip_id, scheduled, category, wish_level DESC);

-- メッセージ取得用複合インデックス
CREATE INDEX idx_messages_trip_timeline ON messages(trip_id, created_at DESC) WHERE is_deleted = false;

-- 通知取得用複合インデックス
CREATE INDEX idx_notifications_user_timeline ON notifications(user_id, created_at DESC) WHERE is_read = false;

-- 使用状況分析用複合インデックス
CREATE INDEX idx_usage_events_analysis ON usage_events(event_type, created_at) WHERE created_at >= CURRENT_DATE - INTERVAL '30 days';
```

### 8.2 部分インデックス
```sql
-- アクティブな招待コードのみ
CREATE INDEX idx_invitation_codes_active ON invitation_codes(trip_id, code) WHERE is_active = true AND (expires_at IS NULL OR expires_at > NOW());

-- 未読通知のみ
CREATE INDEX idx_notifications_unread_recent ON notifications(user_id, created_at DESC) WHERE is_read = false AND created_at >= CURRENT_DATE - INTERVAL '7 days';

-- スケジュール済み場所のみ
CREATE INDEX idx_places_scheduled_dates ON places(trip_id, scheduled_date) WHERE scheduled = true;

-- プレミアムユーザーのみ
CREATE INDEX idx_users_premium_active ON users(id, premium_expires_at) WHERE is_premium = true AND premium_expires_at > NOW();
```

### 8.3 GINインデックス（JSONB用）
```sql
-- 営業時間検索用
CREATE INDEX idx_places_opening_hours_gin ON places USING gin(opening_hours);

-- 通知設定検索用
CREATE INDEX idx_users_notification_settings_gin ON users USING gin(notification_settings);

-- 最適化結果検索用
CREATE INDEX idx_optimization_results_score_gin ON optimization_results USING gin(optimization_score);

-- メッセージメタデータ検索用
CREATE INDEX idx_messages_metadata_gin ON messages USING gin(metadata) WHERE metadata != '{}'::jsonb;
```

## 9. データベース関数（高度）

### 9.1 地理的検索関数
```sql
CREATE OR REPLACE FUNCTION find_nearby_places(
  p_latitude DECIMAL,
  p_longitude DECIMAL,
  p_radius_km DECIMAL DEFAULT 5.0,
  p_category TEXT DEFAULT NULL,
  p_limit INTEGER DEFAULT 20
) RETURNS TABLE (
  place_id UUID,
  place_name TEXT,
  category TEXT,
  distance_km DECIMAL,
  rating DECIMAL
) AS $$
BEGIN
  RETURN QUERY
  SELECT 
    p.id,
    p.name,
    p.category,
    ROUND(
      ST_Distance(
        p.location_point,
        ST_SetSRID(ST_MakePoint(p_longitude, p_latitude), 4326)::geography
      ) / 1000, 2
    ) as distance_km,
    p.rating
  FROM places p
  WHERE 
    p.location_point IS NOT NULL
    AND ST_DWithin(
      p.location_point,
      ST_SetSRID(ST_MakePoint(p_longitude, p_latitude), 4326)::geography,
      p_radius_km * 1000
    )
    AND (p_category = p.category OR p_category IS NULL)
  ORDER BY p.location_point <-> ST_SetSRID(ST_MakePoint(p_longitude, p_latitude), 4326)::geography
  LIMIT p_limit;
END;
$$ LANGUAGE plpgsql SECURITY DEFINER;
```

### 9.2 最適化統計関数
```sql
CREATE OR REPLACE FUNCTION get_optimization_analytics(
  p_user_id UUID DEFAULT NULL,
  p_trip_id UUID DEFAULT NULL,
  p_days_back INTEGER DEFAULT 30
) RETURNS TABLE (
  total_optimizations INTEGER,
  avg_execution_time_ms INTEGER,
  avg_fairness_score DECIMAL,
  avg_efficiency_score DECIMAL,
  places_optimized INTEGER,
  success_rate DECIMAL
) AS $$
DECLARE
  v_start_date TIMESTAMPTZ := NOW() - INTERVAL '1 day' * p_days_back;
BEGIN
  RETURN QUERY
  SELECT 
    COUNT(*)::INTEGER as total_optimizations,
    AVG(execution_time_ms)::INTEGER as avg_execution_time_ms,
    AVG((optimization_score->>'fairness')::DECIMAL) as avg_fairness_score,
    AVG((optimization_score->>'efficiency')::DECIMAL) as avg_efficiency_score,
    SUM(places_count)::INTEGER as places_optimized,
    (COUNT(*) * 100.0 / NULLIF(
      (SELECT COUNT(*) FROM usage_events 
       WHERE event_type IN ('optimization_started', 'optimization_failed')
       AND created_at >= v_start_date
       AND (user_id = p_user_id OR p_user_id IS NULL)
       AND (trip_id = p_trip_id OR p_trip_id IS NULL)
      ), 0
    )) as success_rate
  FROM optimization_results or_data
  WHERE 
    or_data.created_at >= v_start_date
    AND (or_data.created_by = p_user_id OR p_user_id IS NULL)
    AND (or_data.trip_id = p_trip_id OR p_trip_id IS NULL);
END;
$$ LANGUAGE plpgsql SECURITY DEFINER;
```

### 9.3 レコメンデーション関数
```sql
CREATE OR REPLACE FUNCTION recommend_places_for_trip(
  p_trip_id UUID,
  p_limit INTEGER DEFAULT 10
) RETURNS TABLE (
  place_name TEXT,
  category TEXT,
  predicted_rating DECIMAL,
  recommendation_reason TEXT
) AS $$
DECLARE
  v_trip trips%ROWTYPE;
  v_user_preferences JSONB;
BEGIN
  -- 旅行情報取得
  SELECT * INTO v_trip FROM trips WHERE id = p_trip_id;
  
  -- ユーザー嗜好分析
  SELECT jsonb_object_agg(category, avg_wish_level) INTO v_user_preferences
  FROM (
    SELECT 
      p.category,
      AVG(p.wish_level) as avg_wish_level
    FROM places p
    JOIN trip_members tm ON p.trip_id = tm.trip_id
    WHERE tm.trip_id = p_trip_id
    GROUP BY p.category
  ) prefs;
  
  RETURN QUERY
  SELECT 
    sp.name,
    sp.category,
    sp.rating + COALESCE((v_user_preferences->>sp.category)::DECIMAL * 0.1, 0) as predicted_rating,
    CASE 
      WHEN sp.category = ANY(SELECT jsonb_object_keys(v_user_preferences)) 
      THEN 'Based on your team''s preferences for ' || sp.category
      ELSE 'Popular choice near ' || COALESCE(v_trip.destination, v_trip.departure_location)
    END as recommendation_reason
  FROM (
    -- サンプルデータ（実際は外部APIや機械学習モデルから取得）
    SELECT 'Tokyo Skytree' as name, 'Landmark' as category, 4.5 as rating
    UNION ALL
    SELECT 'Senso-ji Temple', 'Temple', 4.3
    UNION ALL
    SELECT 'Tsukiji Fish Market', 'Market', 4.2
  ) sp
  ORDER BY predicted_rating DESC
  LIMIT p_limit;
END;
$$ LANGUAGE plpgsql SECURITY DEFINER;
```

## 10. パフォーマンス監視

### 10.1 スロークエリ監視
```sql
-- スロークエリログ設定
ALTER SYSTEM SET log_min_duration_statement = 1000; -- 1秒以上のクエリをログ
ALTER SYSTEM SET log_statement = 'all';
ALTER SYSTEM SET log_duration = on;

-- クエリパフォーマンス分析ビュー
CREATE VIEW slow_queries_analysis AS
SELECT 
  schemaname,
  tablename,
  attname,
  n_distinct,
  correlation,
  most_common_vals,
  most_common_freqs
FROM pg_stats 
WHERE schemaname = 'public'
ORDER BY tablename, attname;
```

### 10.2 インデックス使用状況監視
```sql
-- インデックス使用統計ビュー
CREATE VIEW index_usage_stats AS
SELECT
  schemaname,
  tablename,
  indexname,
  idx_tup_read,
  idx_tup_fetch,
  idx_scan,
  CASE 
    WHEN idx_scan = 0 THEN 'Unused'
    WHEN idx_scan < 10 THEN 'Low usage'
    ELSE 'Active'
  END as usage_category
FROM pg_stat_user_indexes
WHERE schemaname = 'public'
ORDER BY idx_scan DESC;
```

### 10.3 テーブルサイズ監視
```sql
-- テーブルサイズ分析ビュー
CREATE VIEW table_size_analysis AS
SELECT
  schemaname,
  tablename,
  pg_size_pretty(pg_total_relation_size(schemaname||'.'||tablename)) as total_size,
  pg_size_pretty(pg_relation_size(schemaname||'.'||tablename)) as table_size,
  pg_size_pretty(pg_indexes_size(schemaname||'.'||tablename)) as indexes_size,
  pg_stat_get_live_tuples(c.oid) as live_tuples,
  pg_stat_get_dead_tuples(c.oid) as dead_tuples
FROM pg_tables t
JOIN pg_class c ON c.relname = t.tablename
WHERE schemaname = 'public'
ORDER BY pg_total_relation_size(schemaname||'.'||tablename) DESC;
```

## 11. バックアップ・リカバリ戦略

### 11.1 自動バックアップ設定
```sql
-- Point-in-Time Recovery設定（Supabaseで自動提供）
-- - 日次フルバックアップ
-- - 継続的WALアーカイブ
-- - 最大7日間の復旧ポイント

-- カスタムバックアップ関数
CREATE OR REPLACE FUNCTION create_manual_backup(
  p_backup_name TEXT DEFAULT NULL
) RETURNS TEXT AS $$
DECLARE
  v_backup_name TEXT;
  v_timestamp TEXT;
BEGIN
  v_timestamp := to_char(NOW(), 'YYYY-MM-DD_HH24-MI-SS');
  v_backup_name := COALESCE(p_backup_name, 'manual_backup_' || v_timestamp);
  
  -- 重要テーブルのデータエクスポート
  -- （実際の実装はSupabaseのバックアップ機能を使用）
  
  INSERT INTO usage_events (user_id, event_type, metadata)
  VALUES (
    auth.uid(),
    'manual_backup_created',
    jsonb_build_object('backup_name', v_backup_name, 'timestamp', v_timestamp)
  );
  
  RETURN v_backup_name;
END;
$$ LANGUAGE plpgsql SECURITY DEFINER;
```

### 11.2 データ整合性チェック
```sql
CREATE OR REPLACE FUNCTION check_data_integrity() RETURNS TABLE (
  table_name TEXT,
  check_type TEXT,
  status TEXT,
  details TEXT
) AS $$
BEGIN
  -- 外部キー整合性チェック
  RETURN QUERY
  SELECT 
    'places'::TEXT,
    'foreign_key'::TEXT,
    CASE WHEN COUNT(*) = 0 THEN 'OK' ELSE 'ERROR' END,
    'Orphaned places: ' || COUNT(*)::TEXT
  FROM places p
  LEFT JOIN trips t ON t.id = p.trip_id
  WHERE t.id IS NULL;
  
  RETURN QUERY
  SELECT 
    'trip_members'::TEXT,
    'foreign_key'::TEXT,
    CASE WHEN COUNT(*) = 0 THEN 'OK' ELSE 'ERROR' END,
    'Orphaned trip members: ' || COUNT(*)::TEXT
  FROM trip_members tm
  LEFT JOIN trips t ON t.id = tm.trip_id
  LEFT JOIN users u ON u.id = tm.user_id
  WHERE t.id IS NULL OR u.id IS NULL;
  
  -- 統計情報整合性チェック
  RETURN QUERY
  SELECT 
    'trips'::TEXT,
    'statistics'::TEXT,
    CASE WHEN COUNT(*) = 0 THEN 'OK' ELSE 'WARNING' END,
    'Trips with incorrect statistics: ' || COUNT(*)::TEXT
  FROM trips t
  WHERE t.total_places != (SELECT COUNT(*) FROM places WHERE trip_id = t.id)
     OR t.total_members != (SELECT COUNT(*) FROM trip_members WHERE trip_id = t.id);
END;
$$ LANGUAGE plpgsql SECURITY DEFINER;
```

## 12. 運用・保守

### 12.1 定期メンテナンス
```sql
-- 定期実行される保守関数
CREATE OR REPLACE FUNCTION daily_maintenance() RETURNS TEXT AS $$
DECLARE
  v_result TEXT := '';
  v_cleanup_count INTEGER;
BEGIN
  -- 期限切れデータクリーンアップ
  SELECT cleanup_expired_data() INTO v_cleanup_count;
  v_result := v_result || 'Cleaned up ' || v_cleanup_count || ' expired records. ';
  
  -- テーブル統計更新
  ANALYZE users, trips, places, trip_members, messages, optimization_results;
  v_result := v_result || 'Updated table statistics. ';
  
  -- インデックス最適化（必要に応じて）
  REINDEX INDEX CONCURRENTLY idx_places_trip_id;
  v_result := v_result || 'Reindexed critical indexes. ';
  
  -- データ整合性チェック
  IF EXISTS (
    SELECT 1 FROM check_data_integrity() 
    WHERE status IN ('ERROR', 'WARNING')
  ) THEN
    v_result := v_result || 'WARNING: Data integrity issues detected. ';
  END IF;
  
  RETURN v_result;
END;
$$ LANGUAGE plpgsql SECURITY DEFINER;
```

### 12.2 監視アラート設定
```sql
-- 異常検知関数
CREATE OR REPLACE FUNCTION detect_anomalies() RETURNS TABLE (
  anomaly_type TEXT,
  severity TEXT,
  description TEXT,
  suggested_action TEXT
) AS $$
BEGIN
  -- 大量データ増加検知
  RETURN QUERY
  SELECT 
    'data_growth'::TEXT,
    'WARNING'::TEXT,
    'Table ' || tablename || ' has grown significantly',
    'Consider partitioning or archiving old data'
  FROM table_size_analysis
  WHERE total_size > '1 GB';
  
  -- 未使用インデックス検知
  RETURN QUERY
  SELECT 
    'unused_index'::TEXT,
    'INFO'::TEXT,
    'Index ' || indexname || ' on ' || tablename || ' is unused',
    'Consider dropping this index'
  FROM index_usage_stats
  WHERE usage_category = 'Unused';
  
  -- エラー率急増検知
  RETURN QUERY
  SELECT 
    'error_spike'::TEXT,
    'CRITICAL'::TEXT,
    'High error rate detected in the last hour',
    'Check application logs and system status'
  WHERE (
    SELECT COUNT(*) 
    FROM usage_events 
    WHERE event_type LIKE '%_failed' 
    AND created_at >= NOW() - INTERVAL '1 hour'
  ) > 100;
END;
$$ LANGUAGE plpgsql SECURITY DEFINER;
```

## 13. 移行戦略

### 13.1 初期セットアップ
```sql
-- 初期マイグレーション用スクリプト
DO $$
BEGIN
  -- バージョン管理テーブル作成
  CREATE TABLE IF NOT EXISTS schema_migrations (
    version TEXT PRIMARY KEY,
    applied_at TIMESTAMPTZ DEFAULT NOW()
  );
  
  -- 初期バージョン記録
  INSERT INTO schema_migrations (version) VALUES ('001_initial_schema')
  ON CONFLICT (version) DO NOTHING;
  
  -- サンプルデータ作成（開発環境のみ）
  IF current_database() LIKE '%dev%' OR current_database() LIKE '%test%' THEN
    PERFORM create_sample_data();
  END IF;
END $$;
```

### 13.2 段階的デプロイ
```sql
-- マイグレーション実行チェック
CREATE OR REPLACE FUNCTION can_apply_migration(p_version TEXT) RETURNS BOOLEAN AS $$
BEGIN
  -- 前提条件チェック
  IF NOT EXISTS (SELECT 1 FROM schema_migrations WHERE version = '001_initial_schema') THEN
    RAISE EXCEPTION 'Initial schema not applied';
  END IF;
  
  -- 重複チェック
  IF EXISTS (SELECT 1 FROM schema_migrations WHERE version = p_version) THEN
    RAISE EXCEPTION 'Migration % already applied', p_version;
  END IF;
  
  RETURN TRUE;
END;
$$ LANGUAGE plpgsql;
```

## 14. メンバーカラーシステム

### 14.1 member_colors テーブル

```sql
-- メンバーカラー管理テーブル
CREATE TABLE member_colors (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  trip_id UUID NOT NULL REFERENCES trips(id) ON DELETE CASCADE,
  user_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,
  color_index INTEGER NOT NULL CHECK (color_index >= 0 AND color_index <= 19),
  assigned_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  
  -- 複合ユニーク制約
  UNIQUE(trip_id, user_id),
  UNIQUE(trip_id, color_index)
);

-- インデックス
CREATE INDEX idx_member_colors_trip_id ON member_colors(trip_id);
CREATE INDEX idx_member_colors_user_id ON member_colors(user_id);
CREATE INDEX idx_member_colors_color_index ON member_colors(color_index);
```

### 14.2 places テーブル拡張（カラー関連カラム）

```sql
-- placesテーブルにカラー関連カラムを追加
ALTER TABLE places ADD COLUMN color_data JSONB DEFAULT '{
  "type": "unassigned",
  "primary_color": null,
  "gradient_colors": [],
  "contributor_count": 0
}'::jsonb;

-- placesテーブルにcontributor_user_idsカラムを追加
ALTER TABLE places ADD COLUMN contributor_user_ids UUID[] DEFAULT '{}';

-- インデックス
CREATE INDEX idx_places_color_data ON places USING gin(color_data);
CREATE INDEX idx_places_contributor_user_ids ON places USING gin(contributor_user_ids);
```

### 14.3 trip_members テーブル拡張（カラー関連カラム）

```sql
-- trip_membersテーブルにカラー関連カラムを追加
ALTER TABLE trip_members ADD COLUMN color_index INTEGER CHECK (color_index >= 0 AND color_index <= 19);
ALTER TABLE trip_members ADD COLUMN color_assigned_at TIMESTAMP WITH TIME ZONE;

-- カラーインデックスのユニーク制約
ALTER TABLE trip_members ADD CONSTRAINT trip_members_color_unique UNIQUE (trip_id, color_index);

-- インデックス
CREATE INDEX idx_trip_members_color_index ON trip_members(color_index) WHERE color_index IS NOT NULL;
```

## 15. 地理的制約・Google Places統合

### 15.1 地理的制約テーブル

```sql
-- 地理的制約情報を管理（リアルな経路計算用）
CREATE TABLE geographic_regions (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  name TEXT NOT NULL,
  region_type geographic_constraint_type NOT NULL,
  boundary GEOGRAPHY(POLYGON, 4326),
  
  -- 制約情報
  is_blocked BOOLEAN DEFAULT false,
  travel_cost_multiplier DECIMAL(4,2) DEFAULT 1.0,
  restrictions JSONB DEFAULT '{}'::jsonb,
  
  -- メタデータ
  country_code CHAR(2),
  description TEXT,
  source TEXT DEFAULT 'system',
  
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- インデックス
CREATE INDEX idx_geographic_regions_boundary ON geographic_regions USING GIST(boundary);
CREATE INDEX idx_geographic_regions_type ON geographic_regions(region_type);
CREATE INDEX idx_geographic_regions_country ON geographic_regions(country_code);

-- 交通手段制約テーブル
CREATE TABLE transport_constraints (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  trip_id UUID NOT NULL REFERENCES trips(id) ON DELETE CASCADE,
  
  -- 制約設定
  max_walking_distance_km DECIMAL(6,2) DEFAULT 10.0,
  max_driving_time_hours DECIMAL(4,1) DEFAULT 8.0,
  allowed_transport_modes transport_mode[] DEFAULT ARRAY['walking', 'public_transport', 'car']::transport_mode[],
  
  -- 時間制約
  earliest_departure TIME DEFAULT '06:00:00',
  latest_arrival TIME DEFAULT '22:00:00',
  max_daily_travel_time_hours DECIMAL(4,1) DEFAULT 12.0,
  
  -- コスト制約
  max_transport_cost_per_day INTEGER,
  prefer_free_transport BOOLEAN DEFAULT false,
  
  -- 物理的制約
  wheelchair_accessible BOOLEAN DEFAULT false,
  avoid_highways BOOLEAN DEFAULT false,
  avoid_tolls BOOLEAN DEFAULT false,
  
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- インデックス
CREATE INDEX idx_transport_constraints_trip_id ON transport_constraints(trip_id);
CREATE UNIQUE INDEX idx_transport_constraints_trip_unique ON transport_constraints(trip_id);
```

### 15.2 Google Places キャッシュテーブル

```sql
-- Google Places APIのレスポンスをキャッシュ
CREATE TABLE google_places_cache (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  place_id VARCHAR(255) UNIQUE NOT NULL,
  name TEXT NOT NULL,
  formatted_address TEXT,
  geometry JSONB NOT NULL,
  types TEXT[] DEFAULT '{}',
  rating DECIMAL(2,1),
  user_ratings_total INTEGER,
  price_level INTEGER,
  opening_hours JSONB,
  photos JSONB DEFAULT '[]',
  reviews JSONB DEFAULT '[]',
  website TEXT,
  phone_number TEXT,
  cached_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  expires_at TIMESTAMP WITH TIME ZONE DEFAULT (NOW() + INTERVAL '7 days'),
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- インデックス
CREATE INDEX idx_google_places_cache_place_id ON google_places_cache(place_id);
CREATE INDEX idx_google_places_cache_expires_at ON google_places_cache(expires_at);
CREATE INDEX idx_google_places_cache_types ON google_places_cache USING GIN(types);
CREATE INDEX idx_google_places_cache_geometry ON google_places_cache USING GIST((geometry->>'location'));
```

### 15.3 追加 Row Level Security (RLS) ポリシー

```sql
-- member_colors テーブルのRLS
ALTER TABLE member_colors ENABLE ROW LEVEL SECURITY;

CREATE POLICY "Users can view member colors for trips they are members of" ON member_colors
FOR SELECT USING (
  trip_id IN (
    SELECT trip_id FROM trip_members 
    WHERE user_id = auth.uid()
  )
);

CREATE POLICY "Users can insert member colors for trips they are members of" ON member_colors
FOR INSERT WITH CHECK (
  trip_id IN (
    SELECT trip_id FROM trip_members 
    WHERE user_id = auth.uid()
  )
);

-- geographic_regions テーブルのRLS
ALTER TABLE geographic_regions ENABLE ROW LEVEL SECURITY;

CREATE POLICY "Anyone can view geographic regions" ON geographic_regions
FOR SELECT USING (true);

-- transport_constraints テーブルのRLS
ALTER TABLE transport_constraints ENABLE ROW LEVEL SECURITY;

CREATE POLICY "Users can view transport constraints for trips they are members of" ON transport_constraints
FOR SELECT USING (
  trip_id IN (
    SELECT trip_id FROM trip_members 
    WHERE user_id = auth.uid()
  )
);

CREATE POLICY "Users can manage transport constraints for trips they created" ON transport_constraints
FOR ALL USING (
  trip_id IN (
    SELECT id FROM trips 
    WHERE created_by = auth.uid()
  )
);

-- google_places_cache テーブルのRLS
ALTER TABLE google_places_cache ENABLE ROW LEVEL SECURITY;

CREATE POLICY "Anyone can view cached Google Places data" ON google_places_cache
FOR SELECT USING (true);

CREATE POLICY "System can manage Google Places cache" ON google_places_cache
FOR ALL USING (auth.role() = 'service_role');
```

このデータベース仕様書により、Voypathアプリケーションのすべてのデータ要件が満たされ、スケーラブルで安全なデータベース基盤が構築されます。メンバーカラーシステム、地理的制約機能、Google Places統合を含む完全な機能セットがSupabase + Vercelの環境で最適に動作するよう設計されており、Claude Codeでの実装も容易になります。
